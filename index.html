<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard de KPIs ‚Äî Portafolio de Proyectos</title>
  <meta name="description" content="Dashboard ejecutivo de KPIs con vista general de portafolio y por proyecto, con tabla filtrable, gr√°ficos y chatbot en cliente." />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            navy: '#0b2f6b',
            brand: '#0b2f6b',
            gold: '#f3b21a',
            green: '#16a34a',
            yellow: '#f59e0b',
            red: '#dc2626',
            mute: '#475569'
          },
          boxShadow: {
            glass: '0 10px 30px rgba(2,6,23,.08)'
          },
          borderRadius: {
            xl2: '16px'
          }
        }
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    html, body { height: 100%; }
    body { background: linear-gradient(180deg,#f7fafc 0%,#f3f7ff 100%); }
    .status-pill { display:inline-flex; align-items:center; gap:.5rem; padding:.25rem .6rem; border-radius:999px; font-weight:700; font-size:.75rem; }
    .status-green { background:#e8faef; color:#166534; border:1px solid #bbf7d0; }
    .status-yellow { background:#fffbeb; color:#92400e; border:1px solid #fde68a; }
    .status-red { background:#fef2f2; color:#991b1b; border:1px solid #fecaca; }
    .progress { height: 10px; background:#eef2ff; border-radius:999px; overflow:hidden; }
    .progress > span { display:block; height:100%; background:linear-gradient(90deg,#16a34a,#0ea5e9); width:0; }
    .tooltip { text-decoration: underline dotted; cursor: help; }
    /* Chatbot overlay - MEJORADO */
    .chat-fab { 
      position: fixed; 
      right: 16px; 
      bottom: 16px; 
      z-index: 10000; 
      cursor: pointer;
    }
    .chat-panel { 
      position: fixed; 
      right: 16px; 
      bottom: 76px; 
      width: 400px;
      height: 600px;
      max-width: calc(100vw - 24px); 
      background: #ffffff; 
      border: 1px solid #e2e8f0; 
      border-radius: 16px; 
      box-shadow: 0 20px 40px rgba(2,6,23,.15); 
      display: none;
      flex-direction: column;
      z-index: 10001; 
    }
    .chat-panel.open { 
      display: flex !important;
    }
    .chat-window { 
      flex: 1;
      overflow-y: auto; 
      padding: 16px;
      background: #f8fafc;
    }
    .chat-message {
      margin-bottom: 16px;
      display: flex;
    }
    .chat-message.user {
      justify-content: flex-end;
    }
    .chat-message.bot {
      justify-content: flex-start;
    }
    .chat-bubble {
      max-width: 85%;
      padding: 12px 16px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.5;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .chat-bubble.user {
      background: #0b2f6b;
      color: white;
      border-bottom-right-radius: 4px;
    }
    .chat-bubble.bot {
      background: #ffffff;
      color: #334155;
      border-bottom-left-radius: 4px;
      border: 1px solid #e2e8f0;
    }
    .suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }
    .suggestion-chip {
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      border-radius: 20px;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .suggestion-chip:hover {
      background: #0b2f6b;
      color: white;
    }
    .quick-stats {
      background: #f0f9ff;
      border: 1px solid #bae6fd;
      border-radius: 12px;
      padding: 12px;
      margin: 8px 0;
    }
    .quick-stats-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }
    .quick-stats-item:last-child {
      margin-bottom: 0;
    }
    /* Estilos para el bot√≥n de documentos */
    .btn-documents {
      background: linear-gradient(135deg, #0b2f6b 0%, #1e40af 100%);
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(11, 47, 107, 0.2);
    }
    .btn-documents:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(11, 47, 107, 0.3);
      background: linear-gradient(135deg, #1e40af 0%, #0b2f6b 100%);
    }
  </style>
</head>
<body class="text-slate-900">
  <!-- El resto del c√≥digo del dashboard se mantiene igual -->
  <div class="max-w-7xl mx-auto p-4 lg:p-6">
    <header class="flex items-start justify-between gap-4 pb-4 border-b border-slate-200">
      <div class="flex items-center gap-3">
        <img src="https://cotrafasocial.com/wp-content/uploads/2023/09/logo-cotrafasocial.png" alt="Cotrafa Social" class="h-10 w-auto" />
        <div>
          <h1 class="text-2xl font-black bg-clip-text text-transparent bg-gradient-to-r from-navy via-sky-600 to-gold">Dashboard de KPIs</h1>
          <p class="text-sm text-slate-600">Portafolio de proyectos ‚Äî Vista ejecutiva</p>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <div class="text-right text-sm text-slate-600">
          <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-50 border border-slate-200">
            <span class="font-semibold">√öltima actualizaci√≥n</span>
            <time id="lastUpdated" datetime=""></time>
          </div>
        </div>
        <a href="documentos.html" class="btn-documents inline-flex items-center gap-2 px-4 py-2 text-white rounded-lg font-semibold">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
            <polyline points="10 9 9 9 8 9"/>
          </svg>
          Gesti√≥n de Documentos
        </a>
      </div>
    </header>

    <!-- Resto del contenido del dashboard... -->

  </div>

  <!-- Floating Chatbot - VERSI√ìN MEJORADA -->
  <button id="chatFab" class="chat-fab inline-flex items-center gap-2 px-4 py-3 rounded-full bg-navy text-white font-bold shadow-lg hover:bg-blue-800 transition-colors">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
    </svg>
    Asistente
  </button>
  
  <div id="chatPanel" class="chat-panel">
    <header class="flex items-center justify-between px-4 py-3 border-b border-slate-200 bg-slate-50 rounded-t-2xl">
      <div class="flex items-center gap-2">
        <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
        <h2 class="text-sm font-bold">Asistente de Proyectos</h2>
      </div>
      <button id="chatClose" class="p-2 rounded-full hover:bg-slate-200 transition-colors">‚úï</button>
    </header>
    
    <div id="chatWindow" class="chat-window">
      <!-- Mensaje de bienvenida se insertar√° aqu√≠ -->
    </div>
    
    <form id="chatForm" class="p-3 border-t border-slate-200 bg-white rounded-b-2xl">
      <div id="suggestionsContainer" class="mb-3">
        <!-- Chips de sugerencias se insertar√°n aqu√≠ -->
      </div>
      <div class="flex gap-2">
        <input 
          id="chatInput" 
          type="text" 
          placeholder="Pregunta sobre proyectos, estados, avances..." 
          class="flex-1 border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-navy focus:border-transparent"
        >
        <button 
          type="submit" 
          class="px-4 py-2 bg-navy text-white rounded-lg font-semibold hover:bg-blue-800 transition-colors"
        >
          Enviar
        </button>
      </div>
    </form>
  </div>

  <script>
  (function(){
    // ... (todo el c√≥digo anterior del dashboard se mantiene igual)

    // =============================================
    // CHATBOT MEJORADO - MAYOR ALCANCE
    // =============================================

    const chatFab = document.getElementById('chatFab');
    const chatPanel = document.getElementById('chatPanel');
    const chatClose = document.getElementById('chatClose');
    const chatForm = document.getElementById('chatForm');
    const chatWindow = document.getElementById('chatWindow');
    const chatInput = document.getElementById('chatInput');
    const suggestionsContainer = document.getElementById('suggestionsContainer');

    // Estado del chat
    let isChatOpen = false;
    let chatInitialized = false;

    // Sugerencias de preguntas
    const suggestionChips = [
      "¬øCu√°l es el estado general?",
      "Proyectos atrasados",
      "Pr√≥ximos vencimientos",
      "Estad√≠sticas por responsable",
      "Proyectos por estado",
      "Avance del mes",
      "Riesgos identificados",
      "Recomendaciones"
    ];

    // Funciones de an√°lisis de datos para el chatbot
    function analyzePortfolio() {
      if (projects.length === 0) {
        return { message: "No hay proyectos cargados para analizar." };
      }

      const totalProjects = projects.length;
      const avgProgress = projects.reduce((sum, p) => sum + (p.progress || 0), 0) / totalProjects;
      
      // Proyectos por estado
      const statusCounts = {
        planificacion: projects.filter(p => p.status === 'planificacion').length,
        desarrollo: projects.filter(p => p.status === 'desarrollo').length,
        pruebas: projects.filter(p => p.status === 'pruebas').length,
        revision: projects.filter(p => p.status === 'revision').length,
        completado: projects.filter(p => p.status === 'completado').length,
        pausado: projects.filter(p => p.status === 'pausado').length,
        cancelado: projects.filter(p => p.status === 'cancelado').length
      };

      // Proyectos atrasados (con fecha de fin pasada y no completados)
      const today = new Date();
      const delayedProjects = projects.filter(p => {
        if (!p.endDate || p.status === 'completado') return false;
        return new Date(p.endDate) < today;
      });

      // Pr√≥ximos vencimientos (pr√≥ximos 30 d√≠as)
      const next30Days = new Date();
      next30Days.setDate(today.getDate() + 30);
      const upcomingDeadlines = projects.filter(p => {
        if (!p.endDate || p.status === 'completado') return false;
        const endDate = new Date(p.endDate);
        return endDate > today && endDate <= next30Days;
      });

      // Proyectos con bajo avance (< 25%)
      const lowProgressProjects = projects.filter(p => (p.progress || 0) < 25);

      // Proyectos con alto avance (> 75%)
      const highProgressProjects = projects.filter(p => (p.progress || 0) > 75);

      // Responsables con m√°s proyectos
      const responsibleStats = {};
      projects.forEach(p => {
        if (p.responsible) {
          responsibleStats[p.responsible] = (responsibleStats[p.responsible] || 0) + 1;
        }
      });

      return {
        totalProjects,
        avgProgress,
        statusCounts,
        delayedProjects: delayedProjects.length,
        upcomingDeadlines: upcomingDeadlines.length,
        lowProgressProjects: lowProgressProjects.length,
        highProgressProjects: highProgressProjects.length,
        responsibleStats,
        delayedProjectsList: delayedProjects,
        upcomingDeadlinesList: upcomingDeadlines,
        lowProgressList: lowProgressProjects,
        highProgressList: highProgressProjects
      };
    }

    function getProjectDetails(projectName) {
      const project = projects.find(p => 
        p.name.toLowerCase().includes(projectName.toLowerCase()) ||
        projectName.toLowerCase().includes(p.name.toLowerCase())
      );
      
      if (!project) return null;

      return {
        ...project,
        isDelayed: project.endDate && new Date(project.endDate) < new Date() && project.status !== 'completado',
        daysRemaining: project.endDate ? 
          Math.ceil((new Date(project.endDate) - new Date()) / (1000 * 60 * 60 * 24)) : null
      };
    }

    function getResponsibleProjects(responsibleName) {
      return projects.filter(p => 
        p.responsible && 
        p.responsible.toLowerCase().includes(responsibleName.toLowerCase())
      );
    }

    function generateRecommendations(analysis) {
      const recommendations = [];
      
      if (analysis.delayedProjects > 0) {
        recommendations.push(`‚Ä¢ Revisar los ${analysis.delayedProjects} proyectos atrasados`);
      }
      
      if (analysis.upcomingDeadlines > 0) {
        recommendations.push(`‚Ä¢ Priorizar los ${analysis.upcomingDeadlines} proyectos con vencimiento pr√≥ximo`);
      }
      
      if (analysis.lowProgressProjects > 0) {
        recommendations.push(`‚Ä¢ Dar seguimiento a ${analysis.lowProgressProjects} proyectos con bajo avance`);
      }
      
      if (analysis.avgProgress < 50) {
        recommendations.push(`‚Ä¢ El avance promedio (${analysis.avgProgress.toFixed(1)}%) est√° por debajo del 50%, considerar ajustes`);
      }

      return recommendations.length > 0 ? recommendations : ["‚Ä¢ El portafolio se encuentra en estado saludable"];
    }

    // Funciones del chat mejoradas
    function addMessage(role, text, isHtml = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${role}`;
      
      const bubble = document.createElement('div');
      bubble.className = `chat-bubble ${role}`;
      
      if (isHtml) {
        bubble.innerHTML = text;
      } else {
        bubble.textContent = text;
      }
      
      messageDiv.appendChild(bubble);
      chatWindow.appendChild(messageDiv);
      
      // Scroll to bottom
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function showQuickStats(analysis) {
      const statsHtml = `
        <div class="quick-stats">
          <div class="quick-stats-item">
            <span>üìä Proyectos totales:</span>
            <strong>${analysis.totalProjects}</strong>
          </div>
          <div class="quick-stats-item">
            <span>üìà Avance promedio:</span>
            <strong>${analysis.avgProgress.toFixed(1)}%</strong>
          </div>
          <div class="quick-stats-item">
            <span>‚ö†Ô∏è Atrasados:</span>
            <strong>${analysis.delayedProjects}</strong>
          </div>
          <div class="quick-stats-item">
            <span>üìÖ Pr√≥ximos vencimientos:</span>
            <strong>${analysis.upcomingDeadlines}</strong>
          </div>
        </div>
      `;
      addMessage('bot', statsHtml, true);
    }

    function showSuggestions() {
      suggestionsContainer.innerHTML = '';
      const suggestionsDiv = document.createElement('div');
      suggestionsDiv.className = 'suggestions';
      
      suggestionChips.forEach(suggestion => {
        const chip = document.createElement('div');
        chip.className = 'suggestion-chip';
        chip.textContent = suggestion;
        chip.addEventListener('click', () => {
          chatInput.value = suggestion;
          chatForm.dispatchEvent(new Event('submit'));
        });
        suggestionsDiv.appendChild(chip);
      });
      
      suggestionsContainer.appendChild(suggestionsDiv);
    }

    function processQuestion(question) {
      const q = question.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      const analysis = analyzePortfolio();
      
      // Estado general del portafolio
      if (q.includes('estado general') || q.includes('c√≥mo vamos') || q.includes('resumen')) {
        showQuickStats(analysis);
        const recommendations = generateRecommendations(analysis);
        let response = `<strong>üìà Resumen del Portafolio</strong><br><br>`;
        response += `‚Ä¢ <strong>${analysis.totalProjects}</strong> proyectos activos<br>`;
        response += `‚Ä¢ <strong>${analysis.avgProgress.toFixed(1)}%</strong> avance promedio<br>`;
        response += `‚Ä¢ <strong>${analysis.delayedProjects}</strong> proyectos atrasados<br>`;
        response += `‚Ä¢ <strong>${analysis.upcomingDeadlines}</strong> vencimientos pr√≥ximos<br><br>`;
        response += `<strong>üí° Recomendaciones:</strong><br>`;
        recommendations.forEach(rec => response += `${rec}<br>`);
        return response;
      }

      // Proyectos atrasados
      if (q.includes('atrasado') || q.includes('retraso') || q.includes('vencido')) {
        if (analysis.delayedProjectsList.length === 0) {
          return "üéâ ¬°Excelente! No hay proyectos atrasados en este momento.";
        }
        
        let response = `<strong>‚ö†Ô∏è Proyectos Atrasados (${analysis.delayedProjects})</strong><br><br>`;
        analysis.delayedProjectsList.forEach(project => {
          response += `‚Ä¢ <strong>${project.name}</strong> - ${project.progress || 0}%<br>`;
          if (project.responsible) {
            response += `  üë§ ${project.responsible}<br>`;
          }
        });
        return response;
      }

      // Pr√≥ximos vencimientos
      if (q.includes('pr√≥ximo') || q.includes('vencimiento') || q.includes('deadline')) {
        if (analysis.upcomingDeadlinesList.length === 0) {
          return "üìÖ No hay vencimientos pr√≥ximos en los pr√≥ximos 30 d√≠as.";
        }
        
        let response = `<strong>üìÖ Pr√≥ximos Vencimientos (${analysis.upcomingDeadlines})</strong><br><br>`;
        analysis.upcomingDeadlinesList.forEach(project => {
          const daysLeft = Math.ceil((new Date(project.endDate) - new Date()) / (1000 * 60 * 60 * 24));
          response += `‚Ä¢ <strong>${project.name}</strong> - ${daysLeft} d√≠as<br>`;
          response += `  üìä ${project.progress || 0}% completado<br>`;
        });
        return response;
      }

      // Informaci√≥n espec√≠fica de proyecto
      const projectMatch = projects.find(p => 
        q.includes(p.name.toLowerCase()) || 
        p.name.toLowerCase().includes(q.split(' ')[0])
      );
      
      if (projectMatch) {
        const details = getProjectDetails(projectMatch.name);
        let response = `<strong>üìã ${details.name}</strong><br><br>`;
        response += `‚Ä¢ <strong>Estado:</strong> ${details.status || 'No definido'}<br>`;
        response += `‚Ä¢ <strong>Avance:</strong> ${details.progress || 0}%<br>`;
        if (details.responsible) {
          response += `‚Ä¢ <strong>Responsable:</strong> ${details.responsible}<br>`;
        }
        if (details.startDate) {
          response += `‚Ä¢ <strong>Inicio:</strong> ${new Date(details.startDate).toLocaleDateString('es-ES')}<br>`;
        }
        if (details.endDate) {
          const daysLeft = details.daysRemaining;
          response += `‚Ä¢ <strong>Fin estimado:</strong> ${new Date(details.endDate).toLocaleDateString('es-ES')}`;
          if (daysLeft !== null) {
            response += details.isDelayed ? 
              ` <span style="color: #ef4444;">(‚ö†Ô∏è ${Math.abs(daysLeft)} d√≠as de retraso)</span>` :
              ` (üìÖ ${daysLeft} d√≠as restantes)`;
          }
          response += `<br>`;
        }
        if (details.observations) {
          response += `‚Ä¢ <strong>Observaciones:</strong> ${details.observations}<br>`;
        }
        return response;
      }

      // Proyectos por responsable
      const responsibleMatch = Object.keys(analysis.responsibleStats).find(name => 
        q.includes(name.toLowerCase())
      );
      
      if (responsibleMatch) {
        const responsibleProjects = getResponsibleProjects(responsibleMatch);
        let response = `<strong>üë§ Proyectos de ${responsibleMatch}</strong><br><br>`;
        response += `‚Ä¢ <strong>Total proyectos:</strong> ${responsibleProjects.length}<br>`;
        response += `‚Ä¢ <strong>Avance promedio:</strong> ${(responsibleProjects.reduce((sum, p) => sum + (p.progress || 0), 0) / responsibleProjects.length).toFixed(1)}%<br><br>`;
        
        responsibleProjects.forEach(project => {
          response += `‚Ä¢ <strong>${project.name}</strong> - ${project.progress || 0}% - ${project.status || 'No definido'}<br>`;
        });
        return response;
      }

      // Proyectos por estado
      if (q.includes('estado') && (q.includes('planificaci√≥n') || q.includes('desarrollo') || q.includes('prueba') || q.includes('revisi√≥n') || q.includes('completado') || q.includes('pausado') || q.includes('cancelado'))) {
        let statusType = '';
        if (q.includes('planificaci√≥n')) statusType = 'planificacion';
        else if (q.includes('desarrollo')) statusType = 'desarrollo';
        else if (q.includes('prueba')) statusType = 'pruebas';
        else if (q.includes('revisi√≥n')) statusType = 'revision';
        else if (q.includes('completado')) statusType = 'completado';
        else if (q.includes('pausado')) statusType = 'pausado';
        else if (q.includes('cancelado')) statusType = 'cancelado';

        const statusProjects = projects.filter(p => p.status === statusType);
        const statusNames = {
          'planificacion': 'Planificaci√≥n',
          'desarrollo': 'Desarrollo',
          'pruebas': 'Pruebas',
          'revision': 'Revisi√≥n',
          'completado': 'Completado',
          'pausado': 'Pausado',
          'cancelado': 'Cancelado'
        };

        let response = `<strong>üìä Proyectos en ${statusNames[statusType]} (${statusProjects.length})</strong><br><br>`;
        statusProjects.forEach(project => {
          response += `‚Ä¢ <strong>${project.name}</strong> - ${project.progress || 0}%<br>`;
          if (project.responsible) {
            response += `  üë§ ${project.responsible}<br>`;
          }
        });
        return response;
      }

      // Recomendaciones y riesgos
      if (q.includes('recomendaci√≥n') || q.includes('consejo') || q.includes('riesgo') || q.includes('sugerencia')) {
        const recommendations = generateRecommendations(analysis);
        let response = `<strong>üí° Recomendaciones para el Portafolio</strong><br><br>`;
        recommendations.forEach(rec => response += `${rec}<br>`);
        response += `<br><strong>üìà M√©tricas clave:</strong><br>`;
        response += `‚Ä¢ Avance promedio: ${analysis.avgProgress.toFixed(1)}%<br>`;
        response += `‚Ä¢ Proyectos atrasados: ${analysis.delayedProjects}<br>`;
        response += `‚Ä¢ Proyectos con bajo avance: ${analysis.lowProgressProjects}<br>`;
        return response;
      }

      // Estad√≠sticas generales
      if (q.includes('estad√≠stica') || q.includes('m√©trica') || q.includes('n√∫mero')) {
        let response = `<strong>üìä Estad√≠sticas del Portafolio</strong><br><br>`;
        response += `‚Ä¢ <strong>Total proyectos:</strong> ${analysis.totalProjects}<br>`;
        response += `‚Ä¢ <strong>Avance promedio:</strong> ${analysis.avgProgress.toFixed(1)}%<br>`;
        response += `‚Ä¢ <strong>Proyectos por estado:</strong><br>`;
        Object.entries(analysis.statusCounts).forEach(([status, count]) => {
          if (count > 0) {
            const statusNames = {
              'planificacion': 'üìã Planificaci√≥n',
              'desarrollo': 'üöÄ Desarrollo',
              'pruebas': 'üß™ Pruebas',
              'revision': 'üîç Revisi√≥n',
              'completado': '‚úÖ Completado',
              'pausado': '‚è∏Ô∏è Pausado',
              'cancelado': '‚ùå Cancelado'
            };
            response += `  ${statusNames[status]}: ${count}<br>`;
          }
        });
        return response;
      }

      // Respuesta por defecto con sugerencias
      return `ü§ñ Puedo ayudarte con:<br><br>
      ‚Ä¢ <strong>Estado general</strong> del portafolio<br>
      ‚Ä¢ <strong>Proyectos espec√≠ficos</strong> (menciona el nombre)<br>
      ‚Ä¢ <strong>Proyectos atrasados</strong> o pr√≥ximos a vencer<br>
      ‚Ä¢ <strong>Estad√≠sticas por responsable</strong><br>
      ‚Ä¢ <strong>Proyectos por estado</strong><br>
      ‚Ä¢ <strong>Recomendaciones</strong> y an√°lisis de riesgos<br><br>
      ¬øEn qu√© te puedo ayudar espec√≠ficamente?`;
    }

    function openChat() {
      chatPanel.style.display = 'flex';
      chatPanel.classList.add('open');
      isChatOpen = true;
      
      if (!chatInitialized) {
        const welcomeMessage = `üëã ¬°Hola! Soy tu asistente de proyectos.<br><br>
        Puedo proporcionarte informaci√≥n en tiempo real sobre:<br>
        ‚Ä¢ Estado y avance de proyectos<br>
        ‚Ä¢ An√°lisis de riesgos y recomendaciones<br>
        ‚Ä¢ Pr√≥ximos vencimientos<br>
        ‚Ä¢ Estad√≠sticas por responsable<br>
        ‚Ä¢ Y mucho m√°s...<br><br>
        <em>Usa las sugerencias o escribe tu pregunta.</em>`;
        
        addMessage('bot', welcomeMessage, true);
        showSuggestions();
        chatInitialized = true;
      }
      
      chatInput.focus();
    }

    function closeChat() {
      chatPanel.style.display = 'none';
      chatPanel.classList.remove('open');
      isChatOpen = false;
    }

    function toggleChat() {
      if (isChatOpen) {
        closeChat();
      } else {
        openChat();
      }
    }

    // Event listeners del chat
    chatFab.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      toggleChat();
    });

    chatClose.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      closeChat();
    });

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && isChatOpen) {
        closeChat();
      }
    });

    chatPanel.addEventListener('click', function(e) {
      e.stopPropagation();
    });

    document.addEventListener('click', function(e) {
      if (isChatOpen && !chatPanel.contains(e.target) && e.target !== chatFab) {
        closeChat();
      }
    });

    chatForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const question = chatInput.value.trim();
      
      if (!question) return;
      
      // Agregar mensaje del usuario
      addMessage('user', question);
      chatInput.value = '';
      
      // Mostrar typing indicator
      const typingIndicator = document.createElement('div');
      typingIndicator.className = 'chat-message bot';
      typingIndicator.innerHTML = '<div class="chat-bubble bot">üí≠ Analizando...</div>';
      chatWindow.appendChild(typingIndicator);
      chatWindow.scrollTop = chatWindow.scrollHeight;
      
      // Procesar pregunta despu√©s de un breve delay
      setTimeout(() => {
        // Remover typing indicator
        typingIndicator.remove();
        
        const answer = processQuestion(question);
        addMessage('bot', answer, true);
        showSuggestions();
      }, 1000 + Math.random() * 1000); // Delay aleatorio para simular procesamiento
    });

    // Inicializar chat cerrado
    closeChat();

    // ... (el resto del c√≥digo del dashboard se mantiene igual)

  })();
  </script>
</body>
</html>
