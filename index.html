<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard de KPIs ‚Äî Portafolio de Proyectos</title>
  <meta name="description" content="Dashboard ejecutivo de KPIs con vista general de portafolio y por proyecto, con tabla filtrable, gr√°ficos y chatbot en cliente." />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            navy: '#0b2f6b',
            brand: '#0b2f6b',
            gold: '#f3b21a',
            green: '#16a34a',
            yellow: '#f59e0b',
            red: '#dc2626',
            mute: '#475569'
          },
          boxShadow: {
            glass: '0 10px 30px rgba(2,6,23,.08)'
          },
          borderRadius: {
            xl2: '16px'
          }
        }
      }
    }
  </script>
  <style>
    html, body { height: 100%; }
    body { background: linear-gradient(180deg,#f7fafc 0%,#f3f7ff 100%); }
    
    /* Estados mejorados */
    .status-pill { 
      display:inline-flex; 
      align-items:center; 
      gap:.5rem; 
      padding:.25rem .6rem; 
      border-radius:999px; 
      font-weight:700; 
      font-size:.75rem; 
    }
    .status-green { background:#e8faef; color:#166534; border:1px solid #bbf7d0; }
    .status-yellow { background:#fffbeb; color:#92400e; border:1px solid #fde68a; }
    .status-red { background:#fef2f2; color:#991b1b; border:1px solid #fecaca; }
    .status-blue { background:#eff6ff; color:#1e40af; border:1px solid #dbeafe; }
    .status-purple { background:#faf5ff; color:#7c3aed; border:1px solid #e9d5ff; }
    .status-gray { background:#f8fafc; color:#475569; border:1px solid #e2e8f0; }
    
    .progress { 
      height: 10px; 
      background:#eef2ff; 
      border-radius:999px; 
      overflow:hidden; 
    }
    .progress > span { 
      display:block; 
      height:100%; 
      background:linear-gradient(90deg,#16a34a,#0ea5e9); 
      width:0; 
      transition: width 0.5s ease;
    }
    
    .tooltip { 
      text-decoration: underline dotted; 
      cursor: help; 
    }
    
    /* Cards mejoradas */
    .stat-card {
      transition: all 0.3s ease;
      border: 1px solid #e2e8f0;
    }
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    /* Botones mejorados */
    .btn-primary {
      background: linear-gradient(135deg, #0b2f6b 0%, #1e40af 100%);
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(11, 47, 107, 0.2);
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(11, 47, 107, 0.3);
      background: linear-gradient(135deg, #1e40af 0%, #0b2f6b 100%);
    }
    
    /* Tabs mejorados */
    .tab-active {
      background: #0b2f6b;
      color: white;
    }
    
    /* Chatbot mejorado */
    .chat-fab { 
      position: fixed; 
      right: 16px; 
      bottom: 16px; 
      z-index: 10000; 
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .chat-fab:hover {
      transform: scale(1.05);
    }
    .chat-panel { 
      position: fixed; 
      right: 16px; 
      bottom: 76px; 
      width: 400px;
      height: 600px;
      max-width: calc(100vw - 24px); 
      background: #ffffff; 
      border: 1px solid #e2e8f0; 
      border-radius: 16px; 
      box-shadow: 0 20px 40px rgba(2,6,23,.15); 
      display: none;
      flex-direction: column;
      z-index: 10001; 
    }
    .chat-panel.open { 
      display: flex !important;
      animation: slideInUp 0.3s ease;
    }
    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .chat-window { 
      flex: 1;
      overflow-y: auto; 
      padding: 16px;
      background: #f8fafc;
    }
    .chat-message {
      margin-bottom: 16px;
      display: flex;
    }
    .chat-message.user {
      justify-content: flex-end;
    }
    .chat-message.bot {
      justify-content: flex-start;
    }
    .chat-bubble {
      max-width: 85%;
      padding: 12px 16px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.5;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .chat-bubble.user {
      background: #0b2f6b;
      color: white;
      border-bottom-right-radius: 4px;
    }
    .chat-bubble.bot {
      background: #ffffff;
      color: #334155;
      border-bottom-left-radius: 4px;
      border: 1px solid #e2e8f0;
    }
    .suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }
    .suggestion-chip {
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      border-radius: 20px;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .suggestion-chip:hover {
      background: #0b2f6b;
      color: white;
    }
    
    /* Quick stats para el chat */
    .quick-stats {
      background: #f0f9ff;
      border: 1px solid #bae6fd;
      border-radius: 12px;
      padding: 12px;
      margin: 8px 0;
    }
    .quick-stats-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }
    .quick-stats-item:last-child {
      margin-bottom: 0;
    }
    
    /* Loading states */
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    .pulse {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    /* Empty states */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #9ca3af;
    }
    .empty-state i {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
  </style>
</head>
<body class="text-slate-900">
  <div class="max-w-7xl mx-auto p-4 lg:p-6">
    <!-- Header mejorado -->
    <header class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4 pb-6 border-b border-slate-200">
      <div class="flex items-center gap-3">
        <img src="https://cotrafasocial.com/wp-content/uploads/2023/09/logo-cotrafasocial.png" alt="Cotrafa Social" class="h-10 w-auto" />
        <div>
          <h1 class="text-2xl lg:text-3xl font-black bg-clip-text text-transparent bg-gradient-to-r from-navy via-sky-600 to-gold">Dashboard de KPIs</h1>
          <p class="text-sm text-slate-600">Portafolio de proyectos ‚Äî Vista ejecutiva</p>
        </div>
      </div>
      <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3">
        <div class="text-sm text-slate-600">
          <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-50 border border-slate-200">
            <i class="fas fa-sync-alt text-xs"></i>
            <span class="font-semibold">√öltima actualizaci√≥n:</span>
            <time id="lastUpdated" datetime=""></time>
          </div>
        </div>
        <!-- Bot√≥n mejorado para documentos -->
        <a href="documentos.html" class="btn-primary inline-flex items-center gap-2 px-4 py-2 text-white rounded-lg font-semibold">
          <i class="fas fa-folder-open"></i>
          Gesti√≥n de Documentos
        </a>
      </div>
    </header>

    <!-- Tabs mejorados -->
    <nav class="mt-6" role="tablist" aria-label="Vistas">
      <div class="inline-flex rounded-xl overflow-hidden border border-slate-200 shadow-sm" role="tablist">
        <button id="tab-general" role="tab" aria-controls="view-general" aria-selected="true" class="tab-active px-4 py-2 text-sm font-bold bg-navy text-white hover:bg-blue-800 focus:outline-none transition-colors">
          <i class="fas fa-chart-pie mr-2"></i>
          General
        </button>
        <button id="tab-proyecto" role="tab" aria-controls="view-proyecto" aria-selected="false" class="px-4 py-2 text-sm font-bold bg-white hover:bg-slate-50 border-l border-slate-200 focus:outline-none focus:ring-2 focus:ring-navy transition-colors">
          <i class="fas fa-project-diagram mr-2"></i>
          Por proyecto
        </button>
      </div>
    </nav>

    <!-- View: General -->
    <section id="view-general" role="tabpanel" aria-labelledby="tab-general" class="mt-6 grid gap-6">
      <!-- KPIs resumen portafolio - MEJORADOS -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="stat-card p-4 bg-white/90 backdrop-blur rounded-xl shadow-glass" aria-labelledby="kpi-avg">
          <div class="flex items-center justify-between">
            <h3 id="kpi-avg" class="text-sm font-semibold text-slate-700 flex items-center gap-1">
              <i class="fas fa-chart-line text-blue-500"></i>
              Estado Promedio
            </h3>
            <span id="avgProgressLabel" class="text-sm font-bold text-navy">0%</span>
          </div>
          <div class="progress mt-2" aria-hidden="true">
            <span id="avgProgressBar"></span>
          </div>
          <p class="mt-2 text-xs text-slate-600" id="avgProgressText">Cargando datos...</p>
        </div>
        
        <div class="stat-card p-4 bg-white/90 backdrop-blur rounded-xl shadow-glass">
          <h3 class="text-sm font-semibold text-slate-700 flex items-center gap-1">
            <i class="fas fa-cubes text-green-500"></i>
            Cantidad de Proyectos
          </h3>
          <p class="mt-2 text-2xl font-black text-navy" id="totalProjectsCount">
            <span class="pulse">0</span>
          </p>
          <p class="mt-1 text-xs text-slate-600">Proyectos activos</p>
        </div>
        
        <div class="stat-card p-4 bg-white/90 backdrop-blur rounded-xl shadow-glass">
          <h3 class="text-sm font-semibold text-slate-700 flex items-center gap-1">
            <i class="fas fa-rocket text-purple-500"></i>
            Mes de Creaci√≥n
          </h3>
          <p class="mt-2 text-2xl font-black text-navy" id="creationMonth">‚Äî</p>
          <p class="mt-1 text-xs text-slate-600">Mes m√°s activo</p>
        </div>
        
        <div class="stat-card p-4 bg-white/90 backdrop-blur rounded-xl shadow-glass">
          <h3 class="text-sm font-semibold text-slate-700 flex items-center gap-1">
            <i class="fas fa-flag-checkered text-orange-500"></i>
            Mes de Finalizaci√≥n
          </h3>
          <p class="mt-2 text-2xl font-black text-navy" id="completionMonth">‚Äî</p>
          <p class="mt-1 text-xs text-slate-600">Pr√≥ximas entregas</p>
        </div>
      </div>

      <!-- Charts mejorados -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="stat-card p-4 bg-white/90 backdrop-blur border border-slate-200 rounded-xl shadow-glass">
          <h3 class="text-sm font-semibold text-slate-700 flex items-center gap-2">
            <i class="fas fa-chart-pie text-blue-500"></i>
            Distribuci√≥n por Estado
          </h3>
          <canvas id="statusChart" class="mt-2" aria-label="Gr√°fico de distribuci√≥n por estado" role="img"></canvas>
        </div>
        
        <div class="stat-card p-4 bg-white/90 backdrop-blur border border-slate-200 rounded-xl shadow-glass">
          <h3 class="text-sm font-semibold text-slate-700 flex items-center gap-2">
            <i class="fas fa-chart-bar text-green-500"></i>
            Avance por Proyecto
          </h3>
          <canvas id="progressChart" class="mt-2" aria-label="Gr√°fico de avance por proyecto" role="img"></canvas>
        </div>
        
        <div class="stat-card p-4 bg-white/90 backdrop-blur border border-slate-200 rounded-xl shadow-glass">
          <h3 class="text-sm font-semibold text-slate-700 flex items-center gap-2">
            <i class="fas fa-timeline text-purple-500"></i>
            Timeline de Proyectos
          </h3>
          <canvas id="timelineChart" class="mt-2" aria-label="Gr√°fico de timeline" role="img"></canvas>
        </div>
      </div>

      <!-- Filtros + Tabla mejorados -->
      <div class="stat-card p-4 bg-white/90 backdrop-blur border border-slate-200 rounded-xl shadow-glass">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
          <div class="flex flex-col sm:flex-row gap-3">
            <div class="flex items-center gap-2">
              <label for="searchInput" class="text-sm font-semibold flex items-center gap-1">
                <i class="fas fa-search text-slate-500"></i>
                Buscar
              </label>
              <input id="searchInput" type="search" placeholder="Nombre de proyecto‚Ä¶" class="border border-slate-300 rounded-lg px-3 py-2 text-sm w-48 focus:outline-none focus:ring-2 focus:ring-navy focus:border-transparent" />
            </div>
            <div class="flex items-center gap-2">
              <label for="statusFilter" class="text-sm font-semibold flex items-center gap-1">
                <i class="fas fa-filter text-slate-500"></i>
                Estado
              </label>
              <select id="statusFilter" class="border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-navy focus:border-transparent">
                <option value="">Todos</option>
                <option value="planificacion">Planificaci√≥n</option>
                <option value="desarrollo">Desarrollo</option>
                <option value="pruebas">Pruebas</option>
                <option value="revision">Revisi√≥n</option>
                <option value="completado">Completado</option>
                <option value="pausado">Pausado</option>
                <option value="cancelado">Cancelado</option>
              </select>
            </div>
          </div>
          <div class="text-xs text-slate-500">
            Mostrando <span id="filteredCount">0</span> de <span id="totalCount">0</span> proyectos
          </div>
        </div>

        <div class="overflow-auto rounded-lg border border-slate-200">
          <table class="min-w-full text-sm" role="table" aria-label="Tabla de proyectos">
            <thead class="text-left bg-slate-50">
              <tr>
                <th class="px-4 py-3 font-semibold text-slate-700 border-b border-slate-200">Proyecto</th>
                <th class="px-4 py-3 font-semibold text-slate-700 border-b border-slate-200">% Avance</th>
                <th class="px-4 py-3 font-semibold text-slate-700 border-b border-slate-200">Estado</th>
                <th class="px-4 py-3 font-semibold text-slate-700 border-b border-slate-200">Fecha Inicio</th>
                <th class="px-4 py-3 font-semibold text-slate-700 border-b border-slate-200">Fecha Fin</th>
                <th class="px-4 py-3 font-semibold text-slate-700 border-b border-slate-200">Responsable</th>
                <th class="px-4 py-3 font-semibold text-slate-700 border-b border-slate-200">Observaciones</th>
              </tr>
            </thead>
            <tbody id="projectTableBody" class="bg-white">
              <!-- Filas se cargar√°n aqu√≠ -->
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- View: Proyecto - MEJORADO -->
    <section id="view-proyecto" role="tabpanel" aria-labelledby="tab-proyecto" class="mt-6 grid gap-6 hidden">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 p-4 bg-white/90 backdrop-blur border border-slate-200 rounded-xl shadow-glass">
        <div class="flex items-center gap-2">
          <label for="projectSelect" class="text-sm font-semibold">Proyecto</label>
          <select id="projectSelect" class="border border-slate-300 rounded-lg px-3 py-2 text-sm w-72 focus:outline-none focus:ring-2 focus:ring-navy focus:border-transparent">
            <option value="">Seleccionar proyecto...</option>
          </select>
        </div>
        <div class="text-sm text-slate-600" id="projectMeta">
          Selecciona un proyecto para ver detalles
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="stat-card p-4 bg-white/90 backdrop-blur border border-slate-200 rounded-xl shadow-glass">
          <h3 class="text-sm font-semibold text-slate-700 flex items-center gap-2">
            <i class="fas fa-percentage text-blue-500"></i>
            % de Avance
          </h3>
          <div class="mt-2 progress" aria-hidden="true">
            <span id="projProgressBar"></span>
          </div>
          <p class="mt-2 text-xs text-slate-600" id="projProgressLabel">‚Äî</p>
        </div>
        
        <div class="stat-card p-4 bg-white/90 backdrop-blur border border-slate-200 rounded-xl shadow-glass">
          <h3 class="text-sm font-semibold text-slate-700 flex items-center gap-2">
            <i class="fas fa-tasks text-green-500"></i>
            Estado
          </h3>
          <div class="mt-2" id="projStatus">‚Äî</div>
        </div>
        
        <div class="stat-card p-4 bg-white/90 backdrop-blur border border-slate-200 rounded-xl shadow-glass">
          <h3 class="text-sm font-semibold text-slate-700 flex items-center gap-2">
            <i class="fas fa-calendar-plus text-purple-500"></i>
            Fecha Inicio
          </h3>
          <p class="mt-2 text-xl font-black text-navy" id="projStartDate">‚Äî</p>
          <p class="text-xs text-slate-600">Inicio del proyecto</p>
        </div>
        
        <div class="stat-card p-4 bg-white/90 backdrop-blur border border-slate-200 rounded-xl shadow-glass">
          <h3 class="text-sm font-semibold text-slate-700 flex items-center gap-2">
            <i class="fas fa-flag-checkered text-orange-500"></i>
            Fecha Fin
          </h3>
          <p class="mt-2 text-xl font-black text-navy" id="projEndDate">‚Äî</p>
          <p class="text-xs text-slate-600">Fin estimado</p>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="stat-card p-4 bg-white/90 backdrop-blur border border-slate-200 rounded-xl shadow-glass">
          <h3 class="text-sm font-semibold text-slate-700 flex items-center gap-2 mb-4">
            <i class="fas fa-info-circle text-blue-500"></i>
            Detalles del Proyecto
          </h3>
          <div class="space-y-3" id="projectDetails">
            <div class="empty-state">
              <i class="fas fa-project-diagram"></i>
              <p class="text-lg font-medium">Selecciona un proyecto</p>
              <p class="text-sm mt-2">Elige un proyecto de la lista para ver sus detalles</p>
            </div>
          </div>
        </div>
        
        <div class="stat-card p-4 bg-white/90 backdrop-blur border border-slate-200 rounded-xl shadow-glass">
          <h3 class="text-sm font-semibold text-slate-700 flex items-center gap-2 mb-4">
            <i class="fas fa-file-alt text-green-500"></i>
            Documentos Asociados
          </h3>
          <div id="projectDocuments" class="space-y-2">
            <div class="empty-state">
              <i class="fas fa-folder-open"></i>
              <p class="text-sm mt-2">Los documentos aparecer√°n aqu√≠ al seleccionar un proyecto</p>
            </div>
          </div>
        </div>
      </div>

      <div class="stat-card p-4 bg-white/90 backdrop-blur border border-slate-200 rounded-xl shadow-glass">
        <h3 class="text-sm font-semibold text-slate-700 flex items-center gap-2 mb-4">
          <i class="fas fa-history text-purple-500"></i>
          Historial de Cambios
        </h3>
        <div id="projectHistory" class="space-y-3 max-h-60 overflow-y-auto">
          <div class="empty-state">
            <i class="fas fa-clock"></i>
            <p class="text-sm mt-2">El historial se cargar√° al seleccionar un proyecto</p>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Floating Chatbot mejorado -->
  <button id="chatFab" class="chat-fab inline-flex items-center gap-2 px-4 py-3 rounded-full bg-navy text-white font-bold shadow-lg hover:bg-blue-800 transition-colors">
    <i class="fas fa-robot"></i>
    Asistente
  </button>
  
  <div id="chatPanel" class="chat-panel">
    <header class="flex items-center justify-between px-4 py-3 border-b border-slate-200 bg-slate-50 rounded-t-2xl">
      <div class="flex items-center gap-2">
        <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
        <h2 class="text-sm font-bold">Asistente Inteligente</h2>
      </div>
      <button id="chatClose" class="p-2 rounded-full hover:bg-slate-200 transition-colors">
        <i class="fas fa-times"></i>
      </button>
    </header>
    
    <div id="chatWindow" class="chat-window">
      <!-- Mensajes del chat -->
    </div>
    
    <form id="chatForm" class="p-3 border-t border-slate-200 bg-white rounded-b-2xl">
      <div id="suggestionsContainer" class="mb-3">
        <!-- Sugerencias -->
      </div>
      <div class="flex gap-2">
        <input 
          id="chatInput" 
          type="text" 
          placeholder="Pregunta sobre proyectos, estados, avances..." 
          class="flex-1 border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-navy focus:border-transparent"
        >
        <button 
          type="submit" 
          class="px-4 py-2 bg-navy text-white rounded-lg font-semibold hover:bg-blue-800 transition-colors flex items-center gap-2"
        >
          <i class="fas fa-paper-plane"></i>
          Enviar
        </button>
      </div>
    </form>
  </div>

  <script>
  (function(){
    // Utilidades mejoradas
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
    
    // Estado de la aplicaci√≥n
    let projects = [];
    let filteredProjects = [];
    let charts = {};

    // CORRECCI√ìN: Funci√≥n para corregir el problema de fechas
    function fixDateTimezone(dateString) {
      if (!dateString) return null;
      
      // Crear fecha y ajustar por diferencia de zona horaria
      const date = new Date(dateString);
      const timezoneOffset = date.getTimezoneOffset() * 60000;
      const correctedDate = new Date(date.getTime() + timezoneOffset);
      
      return correctedDate;
    }

    // Funci√≥n para formatear fechas correctamente
    function formatDate(dateString) {
      if (!dateString) return '‚Äî';
      
      const date = fixDateTimezone(dateString);
      if (!date || isNaN(date.getTime())) return '‚Äî';
      
      return date.toLocaleDateString('es-ES', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }

    // Funci√≥n para cargar datos desde localStorage
    function loadProjectData() {
      console.log('üîÑ Cargando datos desde localStorage...');
      
      try {
        // Cargar datos de proyectos desde documentos.html
        const savedProjectData = localStorage.getItem('projectData');
        const savedProjectStatus = localStorage.getItem('projectStatus');
        
        let loadedProjects = [];
        
        // Intentar cargar desde projectStatus primero (m√°s reciente)
        if (savedProjectStatus) {
          try {
            const statusData = JSON.parse(savedProjectStatus);
            if (Array.isArray(statusData)) {
              loadedProjects = statusData.map(project => ({
                id: project.id,
                name: project.name,
                status: project.status,
                progress: project.progress || 0,
                startDate: project.startDate,
                endDate: project.endDate,
                responsible: project.responsible,
                observations: project.observations,
                history: project.history || []
              }));
              console.log('‚úÖ Proyectos cargados desde projectStatus:', loadedProjects.length);
            }
          } catch (error) {
            console.error('‚ùå Error cargando projectStatus:', error);
          }
        }
        
        // Si no hay datos en projectStatus, intentar con projectData
        if (loadedProjects.length === 0 && savedProjectData) {
          try {
            const data = JSON.parse(savedProjectData);
            if (data && Array.isArray(data.projectStatus)) {
              loadedProjects = data.projectStatus;
              console.log('‚úÖ Proyectos cargados desde projectData:', loadedProjects.length);
            }
          } catch (error) {
            console.error('‚ùå Error cargando projectData:', error);
          }
        }

        projects = loadedProjects;
        
        // Si no hay datos, usar datos de ejemplo
        if (projects.length === 0) {
          console.log('üìä Usando datos de ejemplo');
          projects = [
            {
              id: 'project-1',
              name: 'Proyecto Aurora',
              status: 'desarrollo',
              progress: 65,
              startDate: '2024-01-15',
              endDate: '2024-06-30',
              responsible: 'Ana Garc√≠a',
              observations: 'Proyecto en fase de desarrollo avanzada',
              history: [
                {
                  date: '2024-01-15',
                  action: 'Creaci√≥n',
                  details: 'Proyecto creado',
                  user: 'Sistema'
                }
              ]
            },
            {
              id: 'project-2',
              name: 'Proyecto Boreal',
              status: 'planificacion',
              progress: 25,
              startDate: '2024-02-01',
              endDate: '2024-08-15',
              responsible: 'Carlos L√≥pez',
              observations: 'Fase inicial de planificaci√≥n',
              history: [
                {
                  date: '2024-02-01',
                  action: 'Creaci√≥n',
                  details: 'Proyecto creado',
                  user: 'Sistema'
                }
              ]
            }
          ];
        }

        updateDashboard();
        
      } catch (error) {
        console.error('‚ùå Error cr√≠tico cargando datos:', error);
        showError('Error cargando datos de proyectos');
      }
    }

    // Funci√≥n para mostrar errores
    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
      errorDiv.innerHTML = `
        <div class="flex items-center gap-2">
          <i class="fas fa-exclamation-triangle"></i>
          <span>${message}</span>
        </div>
      `;
      document.body.appendChild(errorDiv);
      
      setTimeout(() => {
        errorDiv.remove();
      }, 5000);
    }

    // Funci√≥n para mostrar √©xito
    function showSuccess(message) {
      const successDiv = document.createElement('div');
      successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
      successDiv.innerHTML = `
        <div class="flex items-center gap-2">
          <i class="fas fa-check-circle"></i>
          <span>${message}</span>
        </div>
      `;
      document.body.appendChild(successDiv);
      
      setTimeout(() => {
        successDiv.remove();
      }, 3000);
    }

    // Funci√≥n para actualizar todo el dashboard
    function updateDashboard() {
      console.log('üîÑ Actualizando dashboard con', projects.length, 'proyectos');
      
      try {
        // Actualizar KPIs principales
        updateMainKPIs();
        
        // Actualizar gr√°ficos
        updateCharts();
        
        // Actualizar tabla
        renderTable();
        
        // Actualizar select de proyectos
        updateProjectSelect();
        
        // Actualizar √∫ltima actualizaci√≥n
        updateLastUpdated();
        
        showSuccess('Datos actualizados correctamente');
        
      } catch (error) {
        console.error('‚ùå Error actualizando dashboard:', error);
        showError('Error actualizando el dashboard');
      }
    }

    // Actualizar KPIs principales
    function updateMainKPIs() {
      if (projects.length === 0) {
        document.getElementById('avgProgressLabel').textContent = '0%';
        document.getElementById('avgProgressBar').style.width = '0%';
        document.getElementById('avgProgressText').textContent = 'Sin datos de proyectos';
        document.getElementById('totalProjectsCount').textContent = '0';
        document.getElementById('creationMonth').textContent = '‚Äî';
        document.getElementById('completionMonth').textContent = '‚Äî';
        return;
      }

      // KPI 1: Estado Promedio
      const avgProgress = projects.reduce((sum, p) => sum + (p.progress || 0), 0) / projects.length;
      document.getElementById('avgProgressLabel').textContent = `${avgProgress.toFixed(1)}%`;
      document.getElementById('avgProgressBar').style.width = `${Math.max(0, Math.min(100, avgProgress))}%`;
      document.getElementById('avgProgressText').textContent = `Promedio de ${projects.length} proyectos`;

      // KPI 2: Cantidad de Proyectos
      document.getElementById('totalProjectsCount').textContent = projects.length;

      // KPI 3: Mes de Creaci√≥n
      const startDates = projects.map(p => p.startDate).filter(Boolean);
      const creationMonth = getMostCommonMonth(startDates);
      document.getElementById('creationMonth').textContent = creationMonth;

      // KPI 4: Mes de Finalizaci√≥n
      const endDates = projects.map(p => p.endDate).filter(Boolean);
      const completionMonth = getMostCommonMonth(endDates);
      document.getElementById('completionMonth').textContent = completionMonth;
    }

    // Funci√≥n para obtener el mes m√°s com√∫n
    function getMostCommonMonth(dates) {
      if (dates.length === 0) return '‚Äî';
      
      const monthCounts = {};
      dates.forEach(date => {
        const month = getMonthName(date);
        monthCounts[month] = (monthCounts[month] || 0) + 1;
      });
      
      return Object.keys(monthCounts).reduce((a, b) => 
        monthCounts[a] > monthCounts[b] ? a : b
      );
    }

    // Funci√≥n para obtener nombre del mes
    function getMonthName(dateString) {
      const date = fixDateTimezone(dateString);
      if (!date || isNaN(date.getTime())) return '‚Äî';
      
      const months = [
        'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
        'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
      ];
      return months[date.getMonth()];
    }

    // Actualizar gr√°ficos
    function updateCharts() {
      if (projects.length === 0) {
        // Mostrar estado vac√≠o en gr√°ficos
        destroyCharts();
        return;
      }

      // Destruir gr√°ficos existentes
      destroyCharts();

      // Gr√°fico 1: Distribuci√≥n por Estado
      const statusCounts = {
        planificacion: projects.filter(p => p.status === 'planificacion').length,
        desarrollo: projects.filter(p => p.status === 'desarrollo').length,
        pruebas: projects.filter(p => p.status === 'pruebas').length,
        revision: projects.filter(p => p.status === 'revision').length,
        completado: projects.filter(p => p.status === 'completado').length,
        pausado: projects.filter(p => p.status === 'pausado').length,
        cancelado: projects.filter(p => p.status === 'cancelado').length
      };

      const statusLabels = ['Planificaci√≥n', 'Desarrollo', 'Pruebas', 'Revisi√≥n', 'Completado', 'Pausado', 'Cancelado'];
      const statusData = [
        statusCounts.planificacion,
        statusCounts.desarrollo,
        statusCounts.pruebas,
        statusCounts.revision,
        statusCounts.completado,
        statusCounts.pausado,
        statusCounts.cancelado
      ];

      const statusColors = ['#f59e0b', '#3b82f6', '#8b5cf6', '#f97316', '#10b981', '#6b7280', '#ef4444'];

      const statusCtx = document.getElementById('statusChart');
      if (statusCtx) {
        charts.statusChart = new Chart(statusCtx, {
          type: 'doughnut',
          data: {
            labels: statusLabels,
            datasets: [{
              data: statusData,
              backgroundColor: statusColors,
              borderWidth: 2,
              borderColor: '#ffffff'
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { 
                position: 'bottom',
                labels: {
                  usePointStyle: true,
                  padding: 15
                }
              }
            }
          }
        });
      }

      // Gr√°fico 2: Avance por Proyecto
      const progressCtx = document.getElementById('progressChart');
      if (progressCtx) {
        const projectNames = projects.map(p => p.name);
        const progressData = projects.map(p => p.progress || 0);
        
        charts.progressChart = new Chart(progressCtx, {
          type: 'bar',
          data: {
            labels: projectNames,
            datasets: [{
              label: '% Avance',
              data: progressData,
              backgroundColor: '#0ea5e9',
              borderColor: '#0c8fd6',
              borderWidth: 1,
              borderRadius: 4
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                  callback: value => value + '%'
                },
                grid: {
                  color: 'rgba(0,0,0,0.1)'
                }
              },
              x: {
                grid: {
                  display: false
                }
              }
            },
            plugins: {
              legend: {
                display: false
              }
            }
          }
        });
      }

      // Gr√°fico 3: Timeline
      const timelineCtx = document.getElementById('timelineChart');
      if (timelineCtx) {
        // Agrupar por mes
        const monthlyData = {};
        projects.forEach(project => {
          if (project.startDate) {
            const month = getMonthName(project.startDate);
            monthlyData[month] = (monthlyData[month] || 0) + 1;
          }
        });

        const months = Object.keys(monthlyData);
        const counts = Object.values(monthlyData);

        charts.timelineChart = new Chart(timelineCtx, {
          type: 'line',
          data: {
            labels: months,
            datasets: [{
              label: 'Proyectos por Mes',
              data: counts,
              borderColor: '#10b981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              fill: true,
              tension: 0.4,
              pointBackgroundColor: '#10b981',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1
                },
                grid: {
                  color: 'rgba(0,0,0,0.1)'
                }
              },
              x: {
                grid: {
                  display: false
                }
              }
            }
          }
        });
      }
    }

    function destroyCharts() {
      Object.values(charts).forEach(chart => {
        try {
          chart && chart.destroy();
        } catch (e) {
          console.log('Error destruyendo chart:', e);
        }
      });
      charts = {};
    }

    // Actualizar √∫ltima actualizaci√≥n
    function updateLastUpdated() {
      const lastUpdatedEl = document.getElementById('lastUpdated');
      if (lastUpdatedEl) {
        const now = new Date();
        lastUpdatedEl.setAttribute('datetime', now.toISOString());
        lastUpdatedEl.textContent = now.toLocaleString('es-ES', {
          dateStyle: 'medium',
          timeStyle: 'short'
        });
      }
    }

    // Sistema de tabs
    const tabGeneral = document.getElementById('tab-general');
    const tabProyecto = document.getElementById('tab-proyecto');
    const viewGeneral = document.getElementById('view-general');
    const viewProyecto = document.getElementById('view-proyecto');
    
    function showView(which){
      const isGeneral = which === 'general';
      tabGeneral.setAttribute('aria-selected', isGeneral ? 'true' : 'false');
      tabProyecto.setAttribute('aria-selected', isGeneral ? 'false' : 'true');
      
      // Actualizar clases visuales
      if (isGeneral) {
        tabGeneral.classList.add('tab-active');
        tabGeneral.classList.remove('bg-white');
        tabProyecto.classList.remove('tab-active');
        tabProyecto.classList.add('bg-white');
      } else {
        tabProyecto.classList.add('tab-active');
        tabProyecto.classList.remove('bg-white');
        tabGeneral.classList.remove('tab-active');
        tabGeneral.classList.add('bg-white');
      }
      
      viewGeneral.classList.toggle('hidden', !isGeneral);
      viewProyecto.classList.toggle('hidden', isGeneral);
      
      if (!isGeneral && projects.length > 0) {
        const projectSelect = document.getElementById('projectSelect');
        if (projectSelect.value) {
          renderProject(projectSelect.value);
        } else if (projects[0]) {
          projectSelect.value = projects[0].id;
          renderProject(projects[0].id);
        }
      }
    }
    
    tabGeneral.addEventListener('click', () => showView('general'));
    tabProyecto.addEventListener('click', () => showView('proyecto'));

    // Sistema de tabla y filtros
    const tbody = document.getElementById('projectTableBody');
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const filteredCountEl = document.getElementById('filteredCount');
    const totalCountEl = document.getElementById('totalCount');

    function statusPill(status){
      const statusTexts = {
        'planificacion': 'üìã Planificaci√≥n',
        'desarrollo': 'üöÄ Desarrollo',
        'pruebas': 'üß™ Pruebas',
        'revision': 'üîç Revisi√≥n',
        'completado': '‚úÖ Completado',
        'pausado': '‚è∏Ô∏è Pausado',
        'cancelado': '‚ùå Cancelado'
      };
      
      const base = 'status-pill ';
      const statusClasses = {
        'planificacion': 'status-yellow',
        'desarrollo': 'status-blue',
        'pruebas': 'status-purple',
        'revision': 'status-purple',
        'completado': 'status-green',
        'pausado': 'status-gray',
        'cancelado': 'status-red'
      };
      
      return `<span class="${base}${statusClasses[status] || 'status-gray'}">${statusTexts[status] || status}</span>`;
    }

    function renderTable(){
      const term = (searchInput.value || '').toLowerCase();
      const st = statusFilter.value;
      
      filteredProjects = projects.filter(p => {
        const okTerm = !term || p.name.toLowerCase().includes(term);
        const okSt = !st || p.status === st;
        return okTerm && okSt;
      });
      
      // Actualizar contadores
      filteredCountEl.textContent = filteredProjects.length;
      totalCountEl.textContent = projects.length;
      
      let rows;
      
      if (filteredProjects.length === 0) {
        rows = `<tr>
          <td colspan="7" class="px-4 py-8 text-center text-slate-500">
            <div class="empty-state">
              <i class="fas fa-search"></i>
              <p class="text-lg font-medium">No se encontraron proyectos</p>
              <p class="text-sm mt-2">${projects.length === 0 ? 
                'No hay proyectos cargados. <a href="documentos.html" class="text-navy underline font-semibold">Gestiona proyectos aqu√≠</a>' : 
                'Prueba ajustando los filtros de b√∫squeda'
              }</p>
            </div>
          </td>
        </tr>`;
      } else {
        rows = filteredProjects.map(p => {
          return `<tr class="border-b border-slate-100 hover:bg-slate-50 transition-colors">
            <td class="px-4 py-3 font-semibold text-slate-800">${p.name}</td>
            <td class="px-4 py-3">
              <div class="flex items-center gap-2">
                <div class="progress flex-1">
                  <span style="width: ${p.progress || 0}%"></span>
                </div>
                <span class="text-sm font-medium w-12">${p.progress || 0}%</span>
              </div>
            </td>
            <td class="px-4 py-3">${statusPill(p.status)}</td>
            <td class="px-4 py-3 text-slate-600">${formatDate(p.startDate)}</td>
            <td class="px-4 py-3 text-slate-600">${formatDate(p.endDate)}</td>
            <td class="px-4 py-3 text-slate-600">${p.responsible || '‚Äî'}</td>
            <td class="px-4 py-3 text-sm text-slate-500 max-w-xs truncate">${p.observations || '‚Äî'}</td>
          </tr>`;
        }).join('');
      }
      
      tbody.innerHTML = rows;
    }

    searchInput.addEventListener('input', renderTable);
    statusFilter.addEventListener('change', renderTable);

    // Vista de proyecto individual
    const projectSelect = document.getElementById('projectSelect');
    
    function updateProjectSelect() {
      projectSelect.innerHTML = '<option value="">Seleccionar proyecto...</option>';
      
      if (projects.length > 0) {
        projects.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = p.name;
          projectSelect.appendChild(opt);
        });
      }
    }

    function renderProject(id) {
      const p = projects.find(x => x.id === id);
      if (!p) {
        console.log('Proyecto no encontrado:', id);
        return;
      }
      
      // Informaci√≥n b√°sica
      document.getElementById('projProgressBar').style.width = `${p.progress || 0}%`;
      document.getElementById('projProgressLabel').textContent = `${p.progress || 0}% de avance`;
      document.getElementById('projStatus').innerHTML = statusPill(p.status);
      document.getElementById('projStartDate').textContent = formatDate(p.startDate);
      document.getElementById('projEndDate').textContent = formatDate(p.endDate);
      
      // Actualizar metadata
      document.getElementById('projectMeta').innerHTML = `
        <div class="flex items-center gap-2 text-sm">
          <span class="bg-slate-100 px-2 py-1 rounded">ID: ${p.id}</span>
          <span>‚Ä¢</span>
          <span>Actualizado: ${formatDate(p.lastUpdate || p.history?.[p.history.length-1]?.date)}</span>
        </div>
      `;
      
      // Detalles del proyecto
      const detailsHtml = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
          <div>
            <span class="font-semibold text-slate-600">Responsable:</span>
            <p class="mt-1 text-slate-800">${p.responsible || 'No asignado'}</p>
          </div>
          <div>
            <span class="font-semibold text-slate-600">Estado:</span>
            <p class="mt-1">${p.status || 'No definido'}</p>
          </div>
          <div class="md:col-span-2">
            <span class="font-semibold text-slate-600">Observaciones:</span>
            <p class="mt-1 text-slate-800 bg-slate-50 p-3 rounded-lg">${p.observations || 'Sin observaciones'}</p>
          </div>
        </div>
      `;
      document.getElementById('projectDetails').innerHTML = detailsHtml;
      
      // Cargar documentos asociados desde localStorage
      const projectDocuments = loadProjectDocuments(p.name);
      const docsHtml = projectDocuments.length > 0 ? 
        projectDocuments.map(doc => `
          <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200">
            <div class="flex items-center gap-3">
              <i class="fas fa-file text-slate-400"></i>
              <div>
                <p class="text-sm font-medium text-slate-800">${doc.name}</p>
                <p class="text-xs text-slate-500">${formatDate(doc.uploadDate)} ‚Ä¢ ${doc.categories?.join(', ') || 'Sin categor√≠a'}</p>
              </div>
            </div>
            <span class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded-full">${doc.extension?.toUpperCase() || 'FILE'}</span>
          </div>
        `).join('') : 
        '<div class="empty-state"><i class="fas fa-folder-open"></i><p class="text-sm mt-2">No hay documentos asociados</p></div>';
      document.getElementById('projectDocuments').innerHTML = docsHtml;
      
      // Historial
      const historyHtml = p.history && p.history.length > 0 ? 
        p.history.slice().reverse().map(entry => `
          <div class="border-l-2 border-navy pl-4 py-2">
            <div class="flex justify-between items-start">
              <div>
                <p class="font-medium text-sm text-slate-800">${entry.action}</p>
                <p class="text-xs text-slate-600 mt-1">${entry.details}</p>
              </div>
              <div class="text-right">
                <p class="text-xs text-slate-500">${formatDate(entry.date)}</p>
                <p class="text-xs text-slate-400">${entry.user || 'Sistema'}</p>
              </div>
            </div>
          </div>
        `).join('') : 
        '<div class="empty-state"><i class="fas fa-clock"></i><p class="text-sm mt-2">No hay historial disponible</p></div>';
      document.getElementById('projectHistory').innerHTML = historyHtml;
    }

    // Funci√≥n para cargar documentos asociados a un proyecto
    function loadProjectDocuments(projectName) {
      try {
        const savedDocuments = localStorage.getItem('projectDocuments');
        if (savedDocuments) {
          const documents = JSON.parse(savedDocuments);
          return documents.filter(doc => doc.project === projectName);
        }
      } catch (error) {
        console.error('Error cargando documentos:', error);
      }
      return [];
    }

    projectSelect.addEventListener('change', (e) => {
      if (e.target.value) {
        renderProject(e.target.value);
      }
    });

    // =============================================
    // CHATBOT MEJORADO - FUNCIONALIDAD COMPLETA
    // =============================================

    const chatFab = document.getElementById('chatFab');
    const chatPanel = document.getElementById('chatPanel');
    const chatClose = document.getElementById('chatClose');
    const chatForm = document.getElementById('chatForm');
    const chatWindow = document.getElementById('chatWindow');
    const chatInput = document.getElementById('chatInput');
    const suggestionsContainer = document.getElementById('suggestionsContainer');

    // Estado del chat
    let isChatOpen = false;
    let chatInitialized = false;

    // Sugerencias de preguntas mejoradas
    const suggestionChips = [
      "Estado general del portafolio",
      "Proyectos atrasados",
      "Pr√≥ximos vencimientos", 
      "Proyectos con bajo avance",
      "Documentos pendientes",
      "Responsables con m√°s proyectos",
      "Recomendaciones prioritarias"
    ];

    // Funciones de an√°lisis mejoradas
    function getCompleteProjectContext() {
      console.log('üîÑ Obteniendo contexto completo de proyectos...');
      
      return {
        projects: projects, // Usamos los proyectos ya cargados
        total: projects.length,
        avgProgress: projects.length > 0 ? 
          projects.reduce((sum, p) => sum + (p.progress || 0), 0) / projects.length : 0
      };
    }

    function analyzePortfolio() {
      const context = getCompleteProjectContext();
      
      if (context.projects.length === 0) {
        return { 
          message: "No hay proyectos cargados para analizar.",
          hasData: false
        };
      }

      // An√°lisis detallado
      const statusCounts = {
        planificacion: context.projects.filter(p => p.status === 'planificacion').length,
        desarrollo: context.projects.filter(p => p.status === 'desarrollo').length,
        pruebas: context.projects.filter(p => p.status === 'pruebas').length,
        revision: context.projects.filter(p => p.status === 'revision').length,
        completado: context.projects.filter(p => p.status === 'completado').length,
        pausado: context.projects.filter(p => p.status === 'pausado').length,
        cancelado: context.projects.filter(p => p.status === 'cancelado').length
      };

      // Proyectos atrasados
      const today = new Date();
      const delayedProjects = context.projects.filter(p => {
        if (!p.endDate || p.status === 'completado') return false;
        return new Date(p.endDate) < today;
      });

      // Pr√≥ximos vencimientos (pr√≥ximos 30 d√≠as)
      const next30Days = new Date();
      next30Days.setDate(today.getDate() + 30);
      const upcomingDeadlines = context.projects.filter(p => {
        if (!p.endDate || p.status === 'completado') return false;
        const endDate = new Date(p.endDate);
        return endDate > today && endDate <= next30Days;
      });

      // Proyectos con bajo avance (< 25%)
      const lowProgressProjects = context.projects.filter(p => (p.progress || 0) < 25);

      // Proyectos con alto avance (> 75%)
      const highProgressProjects = context.projects.filter(p => (p.progress || 0) > 75);

      // Responsables con m√°s proyectos
      const responsibleStats = {};
      context.projects.forEach(p => {
        if (p.responsible) {
          if (!responsibleStats[p.responsible]) {
            responsibleStats[p.responsible] = {
              count: 0,
              totalProgress: 0,
              projects: []
            };
          }
          responsibleStats[p.responsible].count++;
          responsibleStats[p.responsible].totalProgress += p.progress || 0;
          responsibleStats[p.responsible].projects.push(p);
        }
      });

      // Calcular promedios por responsable
      Object.keys(responsibleStats).forEach(responsible => {
        responsibleStats[responsible].avgProgress = 
          responsibleStats[responsible].totalProgress / responsibleStats[responsible].count;
      });

      return {
        hasData: true,
        totalProjects: context.total,
        avgProgress: context.avgProgress,
        statusCounts,
        delayedProjects: delayedProjects.length,
        upcomingDeadlines: upcomingDeadlines.length,
        lowProgressProjects: lowProgressProjects.length,
        highProgressProjects: highProgressProjects.length,
        delayedProjectsList: delayedProjects,
        upcomingDeadlinesList: upcomingDeadlines,
        lowProgressList: lowProgressProjects,
        highProgressList: highProgressProjects,
        responsibleStats,
        projects: context.projects
      };
    }

    function getProjectDetails(projectName) {
      const project = projects.find(p => 
        p.name.toLowerCase().includes(projectName.toLowerCase()) ||
        projectName.toLowerCase().includes(p.name.toLowerCase())
      );
      
      if (!project) return null;

      const today = new Date();
      const endDate = project.endDate ? new Date(project.endDate) : null;
      
      return {
        ...project,
        isDelayed: endDate && endDate < today && project.status !== 'completado',
        daysRemaining: endDate ? Math.ceil((endDate - today) / (1000 * 60 * 60 * 24)) : null,
        riskLevel: calculateProjectRisk(project)
      };
    }

    function calculateProjectRisk(project) {
      let riskScore = 0;
      
      // Riesgo por avance bajo
      if (project.progress < 25) riskScore += 3;
      else if (project.progress < 50) riskScore += 2;
      else if (project.progress < 75) riskScore += 1;
      
      // Riesgo por estado
      if (project.status === 'pausado') riskScore += 2;
      if (project.status === 'cancelado') riskScore += 3;
      
      // Riesgo por fecha
      if (project.endDate) {
        const daysLeft = Math.ceil((new Date(project.endDate) - new Date()) / (1000 * 60 * 60 * 24));
        if (daysLeft < 0) riskScore += 3;
        else if (daysLeft < 7) riskScore += 2;
        else if (daysLeft < 30) riskScore += 1;
      }
      
      if (riskScore >= 6) return 'alto';
      if (riskScore >= 3) return 'medio';
      return 'bajo';
    }

    function generateRecommendations(analysis) {
      const recommendations = [];
      
      if (!analysis.hasData) {
        return ["‚Ä¢ Cargar proyectos en la gesti√≥n de documentos para obtener recomendaciones"];
      }
      
      // Recomendaciones basadas en proyectos
      if (analysis.delayedProjects > 0) {
        recommendations.push(`‚Ä¢ Revisar urgentemente los ${analysis.delayedProjects} proyectos atrasados`);
      }
      
      if (analysis.upcomingDeadlines > 0) {
        recommendations.push(`‚Ä¢ Priorizar los ${analysis.upcomingDeadlines} proyectos con vencimiento pr√≥ximo`);
      }
      
      if (analysis.lowProgressProjects > 0) {
        recommendations.push(`‚Ä¢ Dar seguimiento a ${analysis.lowProgressProjects} proyectos con avance inferior al 25%`);
      }
      
      if (analysis.avgProgress < 50) {
        recommendations.push(`‚Ä¢ El avance promedio (${analysis.avgProgress.toFixed(1)}%) est√° bajo, considerar ajustes en la planificaci√≥n`);
      }

      // Recomendaciones por responsable
      Object.entries(analysis.responsibleStats).forEach(([responsible, stats]) => {
        if (stats.avgProgress < 40 && stats.count > 2) {
          recommendations.push(`‚Ä¢ ${responsible} tiene ${stats.count} proyectos con avance promedio bajo (${stats.avgProgress.toFixed(1)}%), considerar redistribuci√≥n`);
        }
      });

      return recommendations.length > 0 ? recommendations : ["‚Ä¢ El portafolio se encuentra en estado saludable. Mantener el seguimiento regular."];
    }

    // Funciones del chat mejoradas
    function addMessage(role, text, isHtml = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${role}`;
      
      const bubble = document.createElement('div');
      bubble.className = `chat-bubble ${role}`;
      
      if (isHtml) {
        bubble.innerHTML = text;
      } else {
        bubble.textContent = text;
      }
      
      messageDiv.appendChild(bubble);
      chatWindow.appendChild(messageDiv);
      
      // Scroll to bottom
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function showQuickStats(analysis) {
      if (!analysis.hasData) {
        addMessage('bot', "üìä No hay datos disponibles. Por favor, carga proyectos en la gesti√≥n de documentos.");
        return;
      }

      const statsHtml = `
        <div class="quick-stats">
          <div class="text-sm font-semibold mb-2 text-navy">üìä Resumen Ejecutivo</div>
          <div class="quick-stats-item">
            <span>üìà Proyectos totales:</span>
            <strong>${analysis.totalProjects}</strong>
          </div>
          <div class="quick-stats-item">
            <span>üéØ Avance promedio:</span>
            <strong>${analysis.avgProgress.toFixed(1)}%</strong>
          </div>
          <div class="quick-stats-item">
            <span>‚ö†Ô∏è Proyectos atrasados:</span>
            <strong style="color: ${analysis.delayedProjects > 0 ? '#ef4444' : '#16a34a'}">${analysis.delayedProjects}</strong>
          </div>
          <div class="quick-stats-item">
            <span>üìÖ Pr√≥ximos vencimientos:</span>
            <strong>${analysis.upcomingDeadlines}</strong>
          </div>
          <div class="quick-stats-item">
            <span>üê¢ Bajo avance:</span>
            <strong style="color: ${analysis.lowProgressProjects > 0 ? '#f59e0b' : '#16a34a'}">${analysis.lowProgressProjects}</strong>
          </div>
        </div>
      `;
      addMessage('bot', statsHtml, true);
    }

    function showSuggestions() {
      suggestionsContainer.innerHTML = '';
      const suggestionsDiv = document.createElement('div');
      suggestionsDiv.className = 'suggestions';
      
      suggestionChips.forEach(suggestion => {
        const chip = document.createElement('div');
        chip.className = 'suggestion-chip';
        chip.textContent = suggestion;
        chip.addEventListener('click', () => {
          chatInput.value = suggestion;
          chatForm.dispatchEvent(new Event('submit'));
        });
        suggestionsDiv.appendChild(chip);
      });
      
      suggestionsContainer.appendChild(suggestionsDiv);
    }

    function processQuestion(question) {
      const q = question.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      const analysis = analyzePortfolio();
      
      if (!analysis.hasData && !q.includes('cargar') && !q.includes('datos')) {
        return `üìä <strong>No hay datos disponibles</strong><br><br>
        Para usar todas las funciones del asistente, necesitas cargar proyectos en la gesti√≥n de documentos.<br><br>
        <a href="documentos.html" style="color: #0b2f6b; text-decoration: underline; font-weight: 500;">Ir a Gesti√≥n de Documentos</a>`;
      }

      // Estado general del portafolio
      if (q.includes('estado general') || q.includes('c√≥mo vamos') || q.includes('resumen') || q.includes('dashboard')) {
        showQuickStats(analysis);
        const recommendations = generateRecommendations(analysis);
        let response = `<strong>üìà An√°lisis Completo del Portafolio</strong><br><br>`;
        
        response += `<strong>Proyectos (${analysis.totalProjects}):</strong><br>`;
        response += `‚Ä¢ Avance promedio: <strong>${analysis.avgProgress.toFixed(1)}%</strong><br>`;
        response += `‚Ä¢ Atrasados: <strong style="color: ${analysis.delayedProjects > 0 ? '#ef4444' : '#16a34a'}">${analysis.delayedProjects}</strong><br>`;
        response += `‚Ä¢ Pr√≥ximos vencimientos: <strong>${analysis.upcomingDeadlines}</strong><br>`;
        response += `‚Ä¢ Bajo avance (<25%): <strong style="color: ${analysis.lowProgressProjects > 0 ? '#f59e0b' : '#16a34a'}">${analysis.lowProgressProjects}</strong><br><br>`;
        
        response += `<strong>üí° Recomendaciones Prioritarias:</strong><br>`;
        recommendations.forEach(rec => response += `${rec}<br>`);
        return response;
      }

      // Proyectos atrasados
      if (q.includes('atrasado') || q.includes('retraso') || q.includes('vencido') || q.includes('urgente')) {
        if (analysis.delayedProjects === 0) {
          return "‚úÖ <strong>No hay proyectos atrasados</strong><br><br>Todos los proyectos est√°n al d√≠a con sus fechas de entrega.";
        }
        
        let response = `<strong>üö® Proyectos Atrasados (${analysis.delayedProjects})</strong><br><br>`;
        analysis.delayedProjectsList.forEach(project => {
          const details = getProjectDetails(project.name);
          response += `‚Ä¢ <strong>${project.name}</strong> - ${project.progress || 0}%<br>`;
          response += `  üìç Estado: ${project.status}<br>`;
          if (project.responsible) {
            response += `  üë§ Responsable: ${project.responsible}<br>`;
          }
          if (project.endDate) {
            const daysLate = Math.ceil((new Date() - new Date(project.endDate)) / (1000 * 60 * 60 * 24));
            response += `  üìÖ <span style="color: #ef4444">${daysLate} d√≠as de retraso</span><br>`;
          }
          response += `<br>`;
        });
        return response;
      }

      // Pr√≥ximos vencimientos
      if (q.includes('pr√≥ximo') || q.includes('vencimiento') || q.includes('deadline') || q.includes('entreg')) {
        if (analysis.upcomingDeadlines === 0) {
          return "‚úÖ <strong>No hay vencimientos pr√≥ximos</strong><br><br>No hay proyectos con fechas de entrega en los pr√≥ximos 30 d√≠as.";
        }
        
        let response = `<strong>üìÖ Pr√≥ximos Vencimientos (${analysis.upcomingDeadlines})</strong><br><br>`;
        analysis.upcomingDeadlinesList.forEach(project => {
          const details = getProjectDetails(project.name);
          response += `‚Ä¢ <strong>${project.name}</strong> - ${project.progress || 0}%<br>`;
          response += `  üìç Estado: ${project.status}<br>`;
          if (project.endDate) {
            const daysLeft = Math.ceil((new Date(project.endDate) - new Date()) / (1000 * 60 * 60 * 24));
            response += `  üìÖ <strong>${daysLeft} d√≠as restantes</strong><br>`;
          }
          response += `<br>`;
        });
        return response;
      }

      // Proyectos con bajo avance
      if (q.includes('bajo avance') || q.includes('lento') || q.includes('estancado') || q.includes('problema')) {
        if (analysis.lowProgressProjects === 0) {
          return "‚úÖ <strong>No hay proyectos con bajo avance</strong><br><br>Todos los proyectos tienen un avance superior al 25%.";
        }
        
        let response = `<strong>üê¢ Proyectos con Bajo Avance (${analysis.lowProgressProjects})</strong><br><br>`;
        analysis.lowProgressList.forEach(project => {
          response += `‚Ä¢ <strong>${project.name}</strong> - ${project.progress || 0}%<br>`;
          response += `  üìç Estado: ${project.status}<br>`;
          if (project.responsible) {
            response += `  üë§ Responsable: ${project.responsible}<br>`;
          }
          response += `<br>`;
        });
        return response;
      }

      // Informaci√≥n espec√≠fica de proyecto
      const projectMatch = analysis.projects.find(p => 
        q.includes(p.name.toLowerCase()) || 
        p.name.toLowerCase().includes(q.split(' ')[0])
      );
      
      if (projectMatch) {
        const details = getProjectDetails(projectMatch.name);
        let response = `<strong>üìã ${details.name}</strong><br>`;
        response += `<div style="background: #f8fafc; padding: 12px; border-radius: 8px; margin: 8px 0;">`;
        
        response += `<strong>Informaci√≥n del Proyecto:</strong><br>`;
        response += `‚Ä¢ <strong>Estado:</strong> ${details.status || 'No definido'}<br>`;
        response += `‚Ä¢ <strong>Avance:</strong> ${details.progress || 0}%<br>`;
        response += `‚Ä¢ <strong>Nivel de riesgo:</strong> <span style="color: ${
          details.riskLevel === 'alto' ? '#ef4444' : 
          details.riskLevel === 'medio' ? '#f59e0b' : '#16a34a'
        }">${details.riskLevel.toUpperCase()}</span><br>`;
        
        if (details.responsible) {
          response += `‚Ä¢ <strong>Responsable:</strong> ${details.responsible}<br>`;
        }
        if (details.startDate) {
          response += `‚Ä¢ <strong>Inicio:</strong> ${formatDate(details.startDate)}<br>`;
        }
        if (details.endDate) {
          const daysLeft = details.daysRemaining;
          response += `‚Ä¢ <strong>Fin estimado:</strong> ${formatDate(details.endDate)}`;
          if (daysLeft !== null) {
            response += details.isDelayed ? 
              ` <span style="color: #ef4444;">(‚ö†Ô∏è ${Math.abs(daysLeft)} d√≠as de retraso)</span>` :
              ` (üìÖ ${daysLeft} d√≠as restantes)`;
          }
          response += `<br>`;
        }
        if (details.observations) {
          response += `‚Ä¢ <strong>Observaciones:</strong> ${details.observations}<br>`;
        }
        
        response += `</div>`;
        return response;
      }

      // Proyectos por responsable
      const responsibleMatch = Object.keys(analysis.responsibleStats).find(name => 
        q.includes(name.toLowerCase())
      );
      
      if (responsibleMatch) {
        const responsibleData = analysis.responsibleStats[responsibleMatch];
        let response = `<strong>üë§ An√°lisis de ${responsibleMatch}</strong><br><br>`;
        
        response += `<strong>M√©tricas:</strong><br>`;
        response += `‚Ä¢ Total proyectos: <strong>${responsibleData.count}</strong><br>`;
        response += `‚Ä¢ Avance promedio: <strong>${responsibleData.avgProgress.toFixed(1)}%</strong><br>`;
        response += `‚Ä¢ Proyectos completados: <strong>${responsibleData.projects.filter(p => p.status === 'completado').length}</strong><br><br>`;
        
        response += `<strong>Proyectos asignados:</strong><br>`;
        response += `<div style="max-height: 200px; overflow-y: auto;">`;
        responsibleData.projects.forEach(project => {
          const riskLevel = calculateProjectRisk(project);
          const riskColor = riskLevel === 'alto' ? '#ef4444' : riskLevel === 'medio' ? '#f59e0b' : '#16a34a';
          
          response += `<div style="border-left: 3px solid ${riskColor}; padding-left: 8px; margin: 4px 0;">`;
          response += `<strong>${project.name}</strong> - ${project.progress || 0}%<br>`;
          response += `<small>Estado: ${project.status} | Riesgo: <span style="color: ${riskColor}">${riskLevel}</span></small>`;
          response += `</div>`;
        });
        response += `</div>`;
        
        return response;
      }

      // Documentos pendientes
      if (q.includes('documento') || q.includes('archivo') || q.includes('pdf') || q.includes('aprobaci√≥n')) {
        return `üìÑ <strong>Gesti√≥n de Documentos</strong><br><br>
        Para consultar informaci√≥n espec√≠fica sobre documentos, te recomiendo:<br><br>
        ‚Ä¢ <strong>Ir a la pesta√±a de Gesti√≥n de Documentos</strong><br>
        ‚Ä¢ <strong>Filtrar por proyecto espec√≠fico</strong><br>
        ‚Ä¢ <strong>Revisar documentos asociados</strong><br><br>
        <a href="documentos.html" style="color: #0b2f6b; text-decoration: underline; font-weight: 500;">Abrir Gesti√≥n de Documentos</a>`;
      }

      // Recomendaciones
      if (q.includes('recomendaci√≥n') || q.includes('consejo') || q.includes('sugerencia') || q.includes('qu√© hacer')) {
        const recommendations = generateRecommendations(analysis);
        let response = `<strong>üí° Recomendaciones Inteligentes</strong><br><br>`;
        response += `<strong>Basado en el an√°lisis de ${analysis.totalProjects} proyectos:</strong><br><br>`;
        
        response += `<strong>Acciones recomendadas:</strong><br>`;
        recommendations.forEach((rec, index) => {
          response += `${index + 1}. ${rec}<br>`;
        });
        return response;
      }

      // Respuesta por defecto mejorada
      return `ü§ñ <strong>Asistente Inteligente de Proyectos</strong><br><br>
      Puedo ayudarte con:<br><br>
      
      <strong>üìä An√°lisis General</strong><br>
      ‚Ä¢ Estado completo del portafolio<br>
      ‚Ä¢ Proyectos atrasados<br>
      ‚Ä¢ Pr√≥ximos vencimientos<br>
      ‚Ä¢ Proyectos con bajo avance<br><br>
      
      <strong>üîç Informaci√≥n Espec√≠fica</strong><br>
      ‚Ä¢ Detalles de cualquier proyecto<br>
      ‚Ä¢ An√°lisis por responsable<br>
      ‚Ä¢ Niveles de riesgo<br>
      ‚Ä¢ Recomendaciones personalizadas<br><br>
      
      <em>Prueba con: "Estado general", "Proyectos atrasados", o menciona un proyecto espec√≠fico...</em>`;
    }

    function openChat() {
      chatPanel.style.display = 'flex';
      chatPanel.classList.add('open');
      isChatOpen = true;
      
      if (!chatInitialized) {
        const welcomeMessage = `üëã <strong>¬°Hola! Soy tu asistente inteligente de proyectos.</strong><br><br>
        Tengo acceso completo a:<br>
        ‚Ä¢ <strong>${projects.length} proyectos</strong> cargados en el sistema<br>
        ‚Ä¢ <strong>An√°lisis en tiempo real</strong> del portafolio<br>
        ‚Ä¢ <strong>Detecci√≥n de riesgos</strong> automatizada<br>
        ‚Ä¢ <strong>Recomendaciones inteligentes</strong><br><br>
        <em>Usa las sugerencias o preg√∫ntame lo que necesites saber sobre los proyectos.</em>`;
        
        addMessage('bot', welcomeMessage, true);
        showSuggestions();
        chatInitialized = true;
      }
      
      chatInput.focus();
    }

    function closeChat() {
      chatPanel.style.display = 'none';
      chatPanel.classList.remove('open');
      isChatOpen = false;
    }

    function toggleChat() {
      if (isChatOpen) {
        closeChat();
      } else {
        openChat();
      }
    }

    // Event listeners del chat
    chatFab.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      toggleChat();
    });

    chatClose.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      closeChat();
    });

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && isChatOpen) {
        closeChat();
      }
    });

    chatPanel.addEventListener('click', function(e) {
      e.stopPropagation();
    });

    document.addEventListener('click', function(e) {
      if (isChatOpen && !chatPanel.contains(e.target) && e.target !== chatFab) {
        closeChat();
      }
    });

    chatForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const question = chatInput.value.trim();
      
      if (!question) return;
      
      // Agregar mensaje del usuario
      addMessage('user', question);
      chatInput.value = '';
      
      // Mostrar typing indicator
      const typingIndicator = document.createElement('div');
      typingIndicator.className = 'chat-message bot';
      typingIndicator.innerHTML = '<div class="chat-bubble bot"><i class="fas fa-circle-notch fa-spin"></i> Analizando datos...</div>';
      chatWindow.appendChild(typingIndicator);
      chatWindow.scrollTop = chatWindow.scrollHeight;
      
      // Procesar pregunta despu√©s de un breve delay
      setTimeout(() => {
        // Remover typing indicator
        typingIndicator.remove();
        
        const answer = processQuestion(question);
        addMessage('bot', answer, true);
        showSuggestions();
      }, 1000 + Math.random() * 500);
    });

    // Escuchar cambios en localStorage para actualizar en tiempo real
    window.addEventListener('storage', function(e) {
      if (e.key === 'projectStatus' || e.key === 'projectData' || e.key === 'projectDocuments') {
        console.log('üîÑ Datos actualizados desde otra pesta√±a');
        loadProjectData();
      }
    });

    // Tambi√©n verificar cambios peri√≥dicamente
    setInterval(loadProjectData, 10000);

    // Inicializar aplicaci√≥n
    loadProjectData();
    showView('general');
    closeChat();

    console.log('‚úÖ Dashboard inicializado correctamente');

  })();
  </script>
</body>
</html>
