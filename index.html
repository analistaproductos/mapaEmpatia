<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mapa de Empatía — COTRAFA SOCIAL (Versión Ejecutiva)</title>
  <meta name="description" content="Mapa de Empatía para el asistente virtual de COTRAFA SOCIAL, presentado en un formato ejecutivo, claro y listo para imprimir." />
  <meta name="theme-color" content="#0b2f6b" />
  <meta name="color-scheme" content="light" />
  <meta property="og:title" content="Mapa de Empatía — COTRAFA SOCIAL" />
  <meta property="og:description" content="Resumen ejecutivo del mapa de empatía del asistente virtual de COTRAFA SOCIAL." />
  <meta property="og:type" content="website" />
  <link rel="icon" href="https://cotrafasocial.com/wp-content/uploads/2023/09/logo-cotrafasocial.png" />

  <!-- Tipografía del sistema para máxima compatibilidad -->
  <style>
    :root {
      /* Paleta COTRAFA SOCIAL — aproximada desde el logo */
      --navy: #0b2f6b;        /* Azul corporativo (COTRAFA SOCIAL) */
      --navy-600: #113a82;    
      --gold: #f3b21a;        /* Amarillo dorado */
      --green: #0f8a3b;       /* Verde */
      --teal: #0ca3c3;        /* Turquesa */

      /* Mapeo a variables existentes */
      --brand: var(--navy);
      --brand-600: var(--navy-600);
      --brand-100: #eaf0fb;
      --accent: var(--gold);
      --accent-100: #fff6da;

      --ink: #0f172a;         /* Azul pizarra oscuro */
      --muted: #475569;       /* Gris azulado para secundarios */
      --line: #e2e8f0;        /* Borde claro */
      --surface: rgba(255,255,255,0.82); /* Glass */
      --bg: linear-gradient(180deg, #f7fafc 0%, #f3f7ff 100%);
      --radius: 16px;
      --shadow-sm: 0 2px 10px rgba(2, 6, 23, 0.06);
      --shadow-md: 0 12px 30px rgba(2, 6, 23, 0.10);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    body {
      margin: 0;
      font-family: Inter, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji", "Noto Color Emoji", sans-serif;
      color: var(--ink);
      background: var(--bg);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      padding: 32px 20px;
    }

    .wrap { max-width: 1200px; margin: 0 auto; }

    header.header {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 16px;
      margin-bottom: 28px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .brand-mark { /* reemplazado por logo oficial */ display:none; }
    .brand-logo { height: 44px; width: auto; display: block; }
    .brand-logo-link { display: inline-flex; align-items: center; }
    .brand-title { font-size: 20px; font-weight: 800; letter-spacing: 0.2px; color: var(--navy); }
    .brand-sub { font-size: 13px; color: var(--muted); }

    .meta {
      display: grid; justify-items: end; gap: 4px;
      font-size: 12px; color: var(--muted);
    }
    .meta .tag {
      background: var(--brand-100); color: var(--brand);
      border: 1px solid #cde6df; padding: 4px 10px; border-radius: 999px; font-weight: 600;
    }

    h1.page-title {
      font-size: 30px; font-weight: 900; margin: 8px 0 18px; letter-spacing: 0.2px;
      background: linear-gradient(90deg, var(--navy), var(--teal), var(--gold));
      -webkit-background-clip: text; background-clip: text; color: transparent;
    }
    p.lead { margin: 0 0 24px; color: var(--muted); }

    /* Tarjetas y layout */
    .grid {
      display: grid; gap: 16px;
      grid-template-columns: repeat(12, 1fr);
    }
    .card {
      background: var(--surface);
      backdrop-filter: saturate(140%) blur(8px);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      padding: 20px;
      position: relative;
      overflow: hidden;
    }
    .card::after{
      content:""; position:absolute; inset:0; pointer-events:none; border-radius:inherit;
      background: linear-gradient(120deg, transparent 0 40%, rgba(255,255,255,.2) 50%, transparent 60%);
      transform: translateX(-100%);
      animation: sheen 6s linear infinite;
    }
    .card:hover{ transform: translateY(-2px); box-shadow: var(--shadow-md); transition: .3s ease; }
    @keyframes sheen { to { transform: translateX(100%); } }
    .card h3 { margin: 0 0 10px; font-size: 16px; letter-spacing: 0.3px; }
    .card p { margin: 0; color: var(--muted); }

    .center {
      grid-column: 1 / -1;
      display: grid; grid-template-columns: 1.2fr 2fr; gap: 20px;
      align-items: start;
    }
    .center .who h3 { color: var(--brand); }

    /* Cuadrantes */
    .quad { min-height: 100%; }
    .quad h4 { margin: 0 0 12px; font-size: 15px; letter-spacing: 0.25px; color: var(--brand); }
    .quad ul { list-style: none; margin: 0; padding: 0; }
    .quad li { padding: 6px 0 6px 20px; position: relative; border-bottom: 1px dashed var(--line); }
    .quad li:last-child { border-bottom: none; }
    .quad li::before { content: ""; position: absolute; left: 0; top: 12px;
      width: 8px; height: 8px; border-radius: 2px; 
      background: linear-gradient(135deg, var(--navy), var(--gold));
    }

    /* Bloque Dolores / Ganancias */
    .duo { grid-column: 1 / -1; display: grid; gap: 16px; grid-template-columns: repeat(12, 1fr); }
    .duo .left { grid-column: span 6; border-top: 3px solid #dc2626; }
    .duo .right { grid-column: span 6; border-top: 3px solid #16a34a; }
    .duo h3 { margin-top: 6px; }
    .duo .quad h4 { color: inherit; }

    /* Insights ejecutivos */
    .insights { grid-column: 1 / -1; }
    .insights-grid { display: grid; gap: 12px; grid-template-columns: repeat(12, 1fr); }
    .insights-grid .insite { grid-column: span 3; }
    .insite {
      border: 1px solid var(--line); border-radius: 12px; background: #f9fbfd;
      padding: 16px; box-shadow: var(--shadow-sm);
    }
    .insite strong { display: block; margin-bottom: 6px; font-size: 13px; letter-spacing: 0.3px; color: var(--ink); }
    .section-title { margin: 10px 0 6px; font-size: 14px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }

    footer {
      margin-top: 28px; padding-top: 16px; border-top: 1px solid var(--line);
      display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--muted);
    }
    /* Borde animado del header */
    header.header { position: relative; }
    header.header::after{
      content:""; position:absolute; left:0; right:0; bottom:-6px; height:4px; border-radius:999px;
      background: linear-gradient(90deg, var(--green), var(--teal), var(--gold));
      filter: saturate(120%);
      animation: flow 8s ease-in-out infinite;
      background-size: 200% 100%;
    }
    @keyframes flow { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

    /* Responsivo */
    @media (max-width: 1024px) {
      .center { grid-template-columns: 1fr; }
      .insights-grid .insite { grid-column: span 6; }
      .duo .left, .duo .right { grid-column: span 12; }
    }
    @media (max-width: 640px) {
      .insights-grid .insite { grid-column: span 12; }
    }

    /* Estilos de impresión (A4) */
    @page { size: A4; margin: 14mm; }
    @media print {
      body { background: #fff; padding: 0; }
      .card, .insite { box-shadow: none; backdrop-filter: none; }
      a[href]::after { content: " (" attr(href) ")"; font-size: 10px; color: #64748b; }
      h1.page-title { color: #000; background: none; -webkit-background-clip: initial; }
    }
    /* Accesibilidad: respetar reduce motion */
    @media (prefers-reduced-motion: reduce){
      *{ animation: none !important; transition: none !important; }
    }
  
    /* Iconos minimalistas */
    .ico{display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;margin-right:8px;border-radius:6px;background:linear-gradient(135deg,var(--gold),var(--teal));box-shadow:0 2px 8px rgba(15, 136, 171, .25)}
    .ico svg{width:14px;height:14px;fill:none;stroke:#0b2f6b;stroke-width:1.6}

    /* Botones futuristas */
    .btn{appearance:none;border:0;border-radius:14px;padding:10px 16px;font-weight:700;cursor:pointer;position:relative;overflow:hidden;background:linear-gradient(90deg,var(--navy),var(--teal));color:#fff}
    .btn::before{content:"";position:absolute;inset:-2px;border-radius:16px;padding:2px;background:linear-gradient(90deg,var(--green),var(--teal),var(--gold));-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;animation:flow 8s ease-in-out infinite;background-size:200% 100%}
    .btn:hover{transform:translateY(-1px)}

    /* Orbes de fondo animados */
    .bg-orbs{position:fixed;inset:0;pointer-events:none;z-index:-1;overflow:hidden}
    .bg-orbs span{position:absolute;filter:blur(40px);opacity:.28;border-radius:50%}
    .bg-orbs .o1{background:var(--gold);width:180px;height:180px;left:-40px;top:20vh;animation:float 14s ease-in-out infinite}
    .bg-orbs .o2{background:var(--teal);width:220px;height:220px;right:-60px;top:10vh;animation:float 18s ease-in-out infinite reverse}
    .bg-orbs .o3{background:var(--green);width:160px;height:160px;left:30%;bottom:-60px;animation:float 16s ease-in-out infinite}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-20px)}}

    /* Demo interactivo */
    .demo{display:grid;gap:12px}
    .demo .input{display:flex;gap:8px}
    .demo input[type="text"]{flex:1;border:1px solid var(--line);border-radius:12px;padding:12px 14px;font-size:14px;background:#fff}
    .demo-output{min-height:80px;border:1px dashed var(--line);border-radius:12px;padding:14px;background:#fff}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px}
    .kpi{border:1px solid var(--line);border-radius:12px;padding:12px;background:#f9fbff;text-align:center}
    .kpi strong{display:block;font-size:18px}

    /* KPI tile inside insights */
    .insite .kpis{margin-top:8px}

    /* Chat flotante */
    .chat-launcher{
      position:fixed; right:18px; bottom:18px; z-index:50;
      width:56px; height:56px; border-radius:999px; border:0; cursor:pointer;
      background:linear-gradient(90deg,var(--navy),var(--teal)); color:#fff;
      box-shadow: var(--shadow-md);
      display:inline-flex; align-items:center; justify-content:center;
    }
    .chat-launcher:hover{ transform: translateY(-1px); }
    .chat-launcher svg{ width:24px; height:24px; fill:none; stroke:#fff; stroke-width:1.8 }

    .chat-widget{
      position:fixed; right:18px; bottom:86px; z-index:50;
      width:380px; max-width:calc(100vw - 32px); max-height:72vh;
      display:none; grid-template-rows:auto 1fr auto; gap:10px;
      background:var(--surface); backdrop-filter:saturate(140%) blur(8px);
      border:1px solid var(--line); border-radius:16px; box-shadow: var(--shadow-md);
      overflow:hidden;
    }
    .chat-widget.open{ display:grid; }
    .chat-header{ display:flex; align-items:center; justify-content:space-between; padding:12px 12px 6px 12px; border-bottom:1px solid var(--line); }
    .chat-title{ display:flex; align-items:center; gap:8px; font-weight:800; color:var(--brand); letter-spacing:.2px; }
    .chat-header .actions{ display:flex; gap:6px; align-items:center }
    .chat-clear{ background:transparent; border:0; color:var(--muted); cursor:pointer; font-size:12px }
    .chat-close{ background:transparent; border:0; width:32px; height:32px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; }
    .chat-close:hover{ background:#f3f6fb }
    .chat-body{ display:grid; grid-template-rows: 1fr auto auto; gap:8px; padding:8px 12px 12px }
    .chat-messages{ overflow:auto; padding-right:4px }
    .chat-suggestions{ display:flex; flex-wrap:wrap; gap:8px; }
    .chip{ border:1px solid var(--line); background:#fff; color:var(--ink); border-radius:999px; padding:6px 10px; font-size:12px; cursor:pointer }
    .chip:hover{ background:#f6faff }
    .chat-input{ display:flex; gap:8px }
    .chat-input input{ flex:1; border:1px solid var(--line); border-radius:12px; padding:12px 12px; font-size:14px; background:#fff }
    .btn-chat{ padding:10px 14px; border-radius:12px }
    .msg{ display:flex; margin:8px 0 }
    .msg .bubble{ max-width:78%; padding:10px 12px; border-radius:14px; line-height:1.4; box-shadow: var(--shadow-sm); }
    .msg.user{ justify-content:flex-end }
    .msg.user .bubble{ background: #0b2f6b; color:#fff; border-top-right-radius:4px }
    .msg.bot{ justify-content:flex-start }
    .msg.bot .bubble{ background:#fff; border:1px solid var(--line); border-top-left-radius:4px }
    .msg small{ display:block; color:var(--muted); margin-top:4px; font-size:11px }

    @media (max-width: 480px){
      .chat-widget{ right:12px; left:12px; width:auto; bottom:80px; max-height:70vh }
      .chat-launcher{ right:12px; bottom:12px }
    }

    </style>
</head>
<body>
  <div class="wrap">
    <div class="bg-orbs" aria-hidden="true">
      <span class="o1"></span>
      <span class="o2"></span>
      <span class="o3"></span>
    </div>
    <header class="header" aria-label="Encabezado">
      <div class="brand">
        <img class="brand-logo" src="https://cotrafasocial.com/wp-content/uploads/2023/09/logo-cotrafasocial.png" alt="COTRAFA SOCIAL" />
        <div>
          <div class="brand-title">COTRAFA SOCIAL</div>
          <div class="brand-sub">Mapa de Empatía — Asistente Virtual</div>
        </div>
      </div>
      <div class="meta">
        <span class="tag">Versión ejecutiva</span>
        <span>Actualizado: <time datetime="2025-10-08">08 oct 2025</time></span>
      </div>
    </header>

    <h1 class="page-title">Mapa de Empatía</h1>
    <p class="lead">Resumen claro y accionable de dolores, expectativas e insights para orientar decisiones de producto y adopción interna.</p>

    <main id="contenido" role="main">
    <!-- Centro: Quién y Necesidad -->
    <section class="card center" aria-labelledby="usuario">
      <div class="who">
        <h3 id="usuario">Usuario objetivo</h3>
        <p><strong>Empleados de COTRAFA SOCIAL</strong></p>
      </div>
      <div class="need">
        <h3>Necesidad clave</h3>
        <p>Consultar rápidamente información de proyectos (ejecutados y en proceso), responsables y documentación asociada en un repositorio confiable.</p>
      </div>
    </section>

    <!-- Cuadrantes -->
    <section class="grid" aria-label="Cuadrantes del mapa">
      <div class="card quad" style="grid-column: span 6;">
        <h4><span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24"><ellipse cx="12" cy="12" rx="8" ry="5"></ellipse><circle cx="12" cy="12" r="2.5"></circle></svg></span>¿Qué ve?</h4>
        <ul>
          <li>Múltiples carpetas en diferentes ubicaciones</li>
          <li>Nomenclaturas inconsistentes de archivos</li>
          <li>Compañeros solicitando información con frecuencia</li>
          <li>Sistemas desactualizados o incompletos</li>
          <li>Documentos duplicados con versiones diferentes</li>
          <li>Ausencia de un repositorio central visible</li>
          <li>Correos antiguos como única fuente histórica</li>
        </ul>
      </div>

      <div class="card quad" style="grid-column: span 6;">
        <h4><span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M8 10 v4 a4 4 0 0 0 8 0 v-4"/><rect x="6" y="9" width="12" height="6" rx="3"/></svg></span>¿Qué escucha?</h4>
        <ul>
          <li>“No sé dónde está ese documento”.</li>
          <li>“Consúltalo con la persona que llevó el proyecto”.</li>
          <li>“Busca en la carpeta compartida”.</li>
          <li>“Esa información está desactualizada”.</li>
          <li>Quejas de clientes por tiempos lentos.</li>
          <li>Solicitudes urgentes de gerencia.</li>
          <li>“Lo necesito para ayer”.</li>
        </ul>
      </div>

      <div class="card quad" style="grid-column: span 6;">
        <h4><span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M12 21c4-3 7-5.5 7-9a7 7 0 0 0-13 0c0 3.5 3 6 6 9z"/></svg></span>¿Qué piensa y siente?</h4>
        <ul>
          <li>“Pierdo tiempo buscando información básica”.</li>
          <li>“¿Esta es la versión correcta?”.</li>
          <li>“Me incomoda preguntar otra vez”.</li>
          <li>“¿Y si decido con información incorrecta?”.</li>
          <li>“Debería haber una forma más sencilla”.</li>
          <li>“Me siento poco productivo, quiero ser más eficiente”.</li>
          <li>“Necesito más autonomía y menos dependencia”.</li>
        </ul>
      </div>

      <div class="card quad" style="grid-column: span 6;">
        <h4><span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="12" rx="4"/><path d="M8 17l-2.5 3"/></svg></span>¿Qué dice y hace?</h4>
        <ul>
          <li>Envía varios correos solicitando información.</li>
          <li>Interrumpe a compañeros para ubicar archivos.</li>
          <li>Explora múltiples carpetas sin éxito.</li>
          <li>Abre versiones hasta hallar la correcta.</li>
          <li>Guarda copias personales por precaución.</li>
          <li>“¿Alguien sabe dónde está el proyecto de…?”</li>
          <li>“¿Esta es la última versión?”</li>
        </ul>
      </div>
    </section>

    <!-- Dolores vs Ganancias -->
    <h2 class="section-title">Dolores y ganancias</h2>
    <section class="grid duo" aria-label="Dolores y ganancias">
      <div class="card quad left">
        <h3>Dolores</h3>
        <ul>
          <li>Pérdida de tiempo en búsquedas.</li>
          <li>Frustración ante respuestas tardías.</li>
          <li>Inseguridad sobre la información.</li>
          <li>Dependencia de personas clave.</li>
          <li>Estrés por tiempos de respuesta.</li>
          <li>Sensación de ineficiencia profesional.</li>
          <li>Duplicación de esfuerzos.</li>
          <li>Miedo a equivocarse.</li>
          <li>Interrupciones constantes.</li>
          <li>Desmotivación por obstáculos evitables.</li>
        </ul>
      </div>
      <div class="card quad right">
        <h3>Ganancias</h3>
        <ul>
          <li>Acceso inmediato a información.</li>
          <li>Búsqueda en lenguaje natural.</li>
          <li>Información vigente y confiable.</li>
          <li>Disponibilidad 24/7.</li>
          <li>Claridad de responsables.</li>
          <li>Trazabilidad de documentos.</li>
          <li>Mayor autonomía.</li>
          <li>Menos interrupciones.</li>
          <li>Respuestas más rápidas a stakeholders.</li>
          <li>Más tiempo para trabajo estratégico.</li>
        </ul>
      </div>
    </section>

    <!-- Demo interactivo -->
    <h2 class="section-title">Demo interactivo</h2>
    <section class="card demo" id="demo">
      <div class="input">
        <input type="text" id="demo-q" placeholder="Ej: ¿Cuál es el estado del proyecto de investigación de mercado?" aria-label="Pregunta de ejemplo" />
        <button class="btn" id="demo-btn" type="button">Probar</button>
      </div>
      <div class="demo-output" id="demo-out" aria-live="polite"></div>
    </section>

    <!-- Insights ejecutivos -->
    <h2 class="section-title">Insights para el diseño</h2>
    <section class="card insights">
      <div class="insights-grid">
        <div class="insite"><strong>1. Lenguaje natural</strong> Debe entender preguntas cotidianas, no solo códigos.</div>
        <div class="insite"><strong>2. Respuestas contextuales</strong> Resumen claro con opción a profundizar.</div>
        <div class="insite"><strong>3. Responsables visibles</strong> Contacto y rol actualizados.</div>
        <div class="insite"><strong>4. Estado de proyectos</strong> Ejecutado, en curso o suspendido.</div>
        <div class="insite"><strong>5. Búsqueda flexible</strong> Por nombre, ubicación, responsable, fecha o tipo.</div>
        <div class="insite"><strong>6. Confiabilidad</strong> Mostrar fecha de actualización y versión.</div>
        <div class="insite"><strong>7. Multiplataforma</strong> Acceso desde distintos dispositivos.</div>
        <div class="insite"><strong>8. Aprendizaje</strong> Mejora continua basada en uso.</div>
        <div class="insite" id="kpi-proyecto">
          <strong>Resumen del proyecto — KPI</strong>
          <div class="kpis">
            <div class="kpi"><span>Estado</span><strong id="kpi-estado">En curso</strong></div>
            <div class="kpi"><span>Avance</span><strong id="kpi-avance">65%</strong></div>
            <div class="kpi"><span>Docs</span><strong id="kpi-docs">3</strong></div>
          </div>
          <div style="margin-top:8px;color:var(--muted);font-size:12px">
            <span>Última actualización:</span> <strong id="kpi-fecha">02 oct 2025</strong>
          </div>
        </div>
      </div>
    </section>

    </main>
    <footer>
      <span>Preparado por: Equipo de Innovación</span>
      <span>© COTRAFA SOCIAL</span>
    </footer>
  </div>
  
  <!-- Chat flotante: Respuestas rápidas -->
  <button id="chat-launcher" class="chat-launcher" aria-label="Abrir chat de respuestas rápidas" aria-controls="chat-panel" aria-expanded="false">
    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M21 12a8 8 0 0 1-8 8H7l-4 3v-6a8 8 0 1 1 18-5z"/></svg>
  </button>
  <section id="chat-panel" class="chat-widget" role="dialog" aria-label="Chat de respuestas rápidas" aria-modal="false" hidden>
    <header class="chat-header">
      <div class="chat-title">
        <span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M21 12a8 8 0 0 1-8 8H7l-4 3v-6a8 8 0 1 1 18-5z"/></svg></span>
        <span>Asistente COTRAFA SOCIAL</span>
      </div>
      <div class="actions">
        <button id="chat-clear" class="chat-clear" type="button" aria-label="Borrar historial">Borrar</button>
        <button id="chat-close" class="chat-close" type="button" aria-label="Cerrar chat">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6 6l12 12M18 6l-12 12" stroke="#0f172a" stroke-width="1.6"/></svg>
        </button>
      </div>
    </header>
    <div class="chat-body">
      <div id="chat-messages" class="chat-messages" aria-live="polite" aria-relevant="additions" aria-atomic="false"></div>
      <div class="chat-suggestions" aria-label="Sugerencias rápidas">
        <button class="chip" data-q="¿Cuál es el estado del proyecto de investigación de mercado?">Estado del proyecto</button>
        <button class="chip" data-q="¿Quién es el responsable del proyecto?">Responsable</button>
        <button class="chip" data-q="Muéstrame los documentos relevantes del proyecto">Documentos</button>
        <button class="chip" data-q="Ayuda">Ayuda</button>
      </div>
      <div class="chat-input">
        <input id="chat-input" type="text" placeholder="Escribe tu pregunta…" aria-label="Escribe tu mensaje" autocomplete="off" />
        <button id="chat-send" class="btn btn-chat" type="button">Enviar</button>
      </div>
    </div>
  </section>

  <script>
    (function(){
      const btn = document.getElementById('demo-btn');
      const out = document.getElementById('demo-out');
      const q = document.getElementById('demo-q');
      if(!btn||!out||!q) return;
      const sample = (text)=>`<div class="insite" style="border:0;background:#fff">`+
        `<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">`+
        `<span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M21 21l-5-5"/><circle cx="10" cy="10" r="6"/></svg></span>`+
        `<strong>Respuesta</strong></div>`+
        `<p><strong>Proyecto:</strong> Investigación de mercado (2025-Q3)<br/>`+
        `<strong>Estado:</strong> En curso ✅<br/>`+
        `<strong>Responsable:</strong> Ana Pérez — Unidad de Innovación<br/>`+
        `<strong>Última actualización:</strong> 02 oct 2025 — Informe preliminar cargado.</p>`+
        `<div class="kpis"><div class="kpi"><span>Tiempo ahorrado</span><strong>7 min</strong></div>`+
        `<div class="kpi"><span>Confianza</span><strong>98%</strong></div>`+
        `<div class="kpi"><span>Docs relevantes</span><strong>3</strong></div></div>`+
        `</div>`;
      function type(html){
        out.innerHTML='';
        const tmp = document.createElement('div');
        tmp.innerHTML = html;
        const text = tmp.innerText;
        let i=0; out.textContent='';
        const timer = setInterval(()=>{
          out.textContent = text.slice(0, i+=3);
          if(i>=text.length){ clearInterval(timer); out.innerHTML = html; }
        }, 12);
      }
      btn.addEventListener('click',()=>{
        const query = q.value.trim()||'¿Cuál es el estado del proyecto de investigación de mercado?';
        type(sample(query));
      });
    })();
  </script>

  <script>
    (function(){
      const STORAGE_KEY = 'COTRAFA_SOCIAL_chat_history_v1';
      const launcher = document.getElementById('chat-launcher');
      const panel = document.getElementById('chat-panel');
      const closeBtn = document.getElementById('chat-close');
      const clearBtn = document.getElementById('chat-clear');
      const messagesEl = document.getElementById('chat-messages');
      const inputEl = document.getElementById('chat-input');
      const sendBtn = document.getElementById('chat-send');
      const chips = Array.from(document.querySelectorAll('.chat-suggestions .chip'));

      if(!launcher || !panel || !messagesEl || !inputEl || !sendBtn) return;

      let messages = loadHistory();
      let busy = false;

      function loadHistory(){
        try{
          const raw = localStorage.getItem(STORAGE_KEY);
          return raw ? JSON.parse(raw) : [];
        }catch{ return []; }
      }
      function saveHistory(){
        try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(messages.slice(-50))); }catch{}
      }
      function now(){
        const d = new Date();
        const pad = (n)=>String(n).padStart(2,'0');
        return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }
      function render(){
        messagesEl.innerHTML = '';
        for(const m of messages){
          const row = document.createElement('div');
          row.className = `msg ${m.role}`;
          const bubble = document.createElement('div');
          bubble.className = 'bubble';
          if(m.html){
            bubble.innerHTML = m.content;
          } else {
            bubble.textContent = m.content;
          }
          const meta = document.createElement('small');
          meta.textContent = m.time || now();
          bubble.appendChild(meta);
          row.appendChild(bubble);
          messagesEl.appendChild(row);
        }
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }
      function addMessage(role, content, opts){
        messages.push({ role, content, time: now(), html: !!(opts && opts.html) });
        saveHistory();
        render();
      }
      function normalize(text){
        return text
          .toLowerCase()
          .normalize('NFD')
          .replace(/\p{Diacritic}/gu,'')
          .replace(/\s+/g,' ') 
          .trim();
      }
      function answerFor(query){
        const qn = normalize(query);
        // Rutas rápidas
        if(/ayuda|help|que puedes hacer|como funcionas/.test(qn)){
          return '<strong>¿Cómo puedo ayudarte?</strong><br/>Puedo darte respuestas rápidas sobre:<ul><li><strong>Estado de proyectos</strong></li><li><strong>Responsables</strong></li><li><strong>Documentos relevantes</strong></li></ul>Usa las sugerencias o escribe tu pregunta.';
        }
        if(/estado.*proyecto|proyecto.*estado|investigacion de mercado/.test(qn)){
          return '<strong>Proyecto:</strong> Investigación de mercado (2025-Q3)<br/><strong>Estado:</strong> En curso ✅<br/><strong>Responsable:</strong> Ana Pérez — Unidad de Innovación<br/><strong>Última actualización:</strong> 02 oct 2025 — Informe preliminar cargado.';
        }
        if(/responsable|quien.*responsable|contacto|encargado/.test(qn)){
          return '<strong>Responsable:</strong> Ana Pérez — Unidad de Innovación<br/><strong>Contacto:</strong> ana.perez@cotrafasocial.com';
        }
        if(/documentos|docs|archivos|evidencias/.test(qn)){
          return '<strong>Documentos relevantes:</strong><ol><li>Acta de inicio — 2025-08-15</li><li>Informe preliminar — 2025-10-02</li><li>Plan de trabajo — 2025-08-10</li></ol>';
        }
        if(/version|actualizacion|ultima.*actualizacion/.test(qn)){
          return '<strong>Última actualización:</strong> 02 oct 2025. Próximo hito: informe final (31 oct 2025).';
        }
        // Por defecto
        return 'No tengo una respuesta específica aún. Prueba con: <em>Estado del proyecto</em>, <em>Responsable</em>, <em>Documentos</em> o escribe <em>Ayuda</em>.';
      }

      function openChat(){
        panel.classList.add('open');
        panel.removeAttribute('hidden');
        launcher.setAttribute('aria-expanded','true');
        setTimeout(()=>inputEl.focus(), 0);
        if(messages.length === 0){
          addMessage('bot', 'Hola, soy el asistente de COTRAFA SOCIAL. ¿En qué te ayudo hoy?');
        } else {
          render();
        }
      }
      function closeChat(){
        panel.classList.remove('open');
        panel.setAttribute('hidden','');
        launcher.setAttribute('aria-expanded','false');
        launcher.focus();
      }
      async function send(){
        const text = inputEl.value.trim();
        if(!text) return;
        addMessage('user', text);
        inputEl.value='';
        // Quick local suggestion first
        const quick = answerFor(text);
        if(quick){
          addMessage('bot', quick, { html: true });
        }
        // Then try backend call
        try{
          if(busy) return; busy = true;
          const resp = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: text, history: messages })
          });
          const data = await resp.json();
          if(data && data.reply){
            addMessage('bot', data.reply, { html: false });
            if(data.kpis){
              const { status, progress, docs, lastUpdate } = data.kpis;
              const estadoEl = document.getElementById('kpi-estado');
              const avanceEl = document.getElementById('kpi-avance');
              const docsEl = document.getElementById('kpi-docs');
              const fechaEl = document.getElementById('kpi-fecha');
              if(estadoEl) estadoEl.textContent = status || 'N/D';
              if(avanceEl) avanceEl.textContent = (progress ?? 'N/D') + (typeof progress==='number'?'%':'');
              if(docsEl) docsEl.textContent = (docs ?? '0');
              if(fechaEl) fechaEl.textContent = lastUpdate || 'N/D';
            }
          } else if(data && data.error){
            // keep quiet, local quick already answered
          }
        } catch {
          // network error: ignore, quick answer already shown
        } finally {
          busy = false;
        }
      }

      launcher.addEventListener('click', ()=>{
        const isOpen = panel.classList.contains('open');
        isOpen ? closeChat() : openChat();
      });
      closeBtn && closeBtn.addEventListener('click', closeChat);
      clearBtn && clearBtn.addEventListener('click', ()=>{
        messages = [];
        saveHistory();
        render();
        addMessage('bot','Historial borrado. ¿Quieres probar con alguna de las sugerencias?');
      });
      sendBtn.addEventListener('click', send);
      inputEl.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); send(); }
        if(e.key === 'Escape'){ closeChat(); }
      });
      chips.forEach(ch => ch.addEventListener('click', ()=>{
        const q = ch.getAttribute('data-q') || ch.textContent || '';
        inputEl.value = q;
        send();
      }));

      // Inicializa KPI con dataset si el backend está disponible
      (async function initKpi(){
        try{
          const r = await fetch('/api/projects');
          const d = await r.json();
          const list = Array.isArray(d.projects) ? d.projects : [];
          if(!list.length) return;
          const target = list.find(p => String(p.name||'').toLowerCase().includes('investigación de mercado')) || list[0];
          const estadoEl = document.getElementById('kpi-estado');
          const avanceEl = document.getElementById('kpi-avance');
          const docsEl = document.getElementById('kpi-docs');
          const fechaEl = document.getElementById('kpi-fecha');
          if(estadoEl) estadoEl.textContent = target.status || 'N/D';
          if(avanceEl) avanceEl.textContent = (target.progress ?? 'N/D') + (typeof target.progress==='number'?'%':'');
          if(docsEl) docsEl.textContent = (target.documents||[]).length;
          if(fechaEl) fechaEl.textContent = target.lastUpdate || 'N/D';
        }catch{}
      })();
    })();
  </script>
</body>
</html>
