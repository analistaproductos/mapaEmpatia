<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mapa de Empatía — Cotrafa Social (Versión Ejecutiva)</title>
  <meta name="description" content="Mapa de Empatía para el asistente virtual de Cotrafa Social, presentado en un formato ejecutivo, claro y listo para imprimir." />
  <style>
    :root{
      --navy:#0b2f6b;--navy-600:#113a82;--gold:#f3b21a;--green:#0f8a3b;--teal:#0ca3c3;
      --brand:var(--navy);--brand-600:var(--navy-600);--brand-100:#eaf0fb;--accent:var(--gold);--accent-100:#fff6da;
      --ink:#0f172a;--muted:#475569;--line:#e2e8f0;--surface:rgba(255,255,255,.82);
      --bg:linear-gradient(180deg,#f7fafc 0%,#f3f7ff 100%);--radius:16px;
      --shadow-sm:0 2px 10px rgba(2,6,23,.06);--shadow-md:0 12px 30px rgba(2,6,23,.10)
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:Inter,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;color:var(--ink);background:var(--bg);line-height:1.5;padding:32px 20px}
    .wrap{max-width:1200px;margin:0 auto}
    header.header{display:grid;grid-template-columns:1fr auto;align-items:center;gap:16px;margin-bottom:28px;position:relative}
    header.header::after{content:"";position:absolute;left:0;right:0;bottom:-6px;height:4px;border-radius:999px;background:linear-gradient(90deg,var(--green),var(--teal),var(--gold));animation:flow 8s ease-in-out infinite;background-size:200% 100%}
    @keyframes flow{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    .brand{display:flex;align-items:center;gap:14px}
    .brand-logo{height:44px;width:auto;display:block}
    .brand-title{font-size:20px;font-weight:800;letter-spacing:.2px;color:var(--navy)}
    .brand-sub{font-size:13px;color:var(--muted)}
    .meta{display:grid;justify-items:end;gap:4px;font-size:12px;color:var(--muted)}
    .meta .tag{background:var(--brand-100);color:var(--brand);border:1px solid #cde6df;padding:4px 10px;border-radius:999px;font-weight:600}
    h1.page-title{font-size:30px;font-weight:900;margin:8px 0 18px;letter-spacing:.2px;background:linear-gradient(90deg,var(--navy),var(--teal),var(--gold));-webkit-background-clip:text;background-clip:text;color:transparent}
    p.lead{margin:0 0 24px;color:var(--muted)}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(12,1fr)}
    .card{background:var(--surface);backdrop-filter:saturate(140%) blur(8px);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow-sm);padding:20px;position:relative;overflow:hidden;transition:.3s ease}
    .card::after{content:"";position:absolute;inset:0;pointer-events:none;border-radius:inherit;background:linear-gradient(120deg,transparent 0 40%,rgba(255,255,255,.2) 50%,transparent 60%);transform:translateX(-100%);animation:sheen 6s linear infinite}
    .card:hover{transform:translateY(-2px);box-shadow:var(--shadow-md)}
    @keyframes sheen{to{transform:translateX(100%)}}
    .card h3{margin:0 0 10px;font-size:16px;letter-spacing:.3px}
    .card p{margin:0;color:var(--muted)}
    .center{grid-column:1/-1;display:grid;grid-template-columns:1.2fr 2fr;gap:20px;align-items:start}
    .center .who h3{color:var(--brand)}
    .quad{min-height:100%}
    .quad h4{margin:0 0 12px;font-size:15px;letter-spacing:.25px;color:var(--brand);display:flex;align-items:center}
    .quad ul{list-style:none;margin:0;padding:0}
    .quad li{padding:6px 0 6px 20px;position:relative;border-bottom:1px dashed var(--line)}
    .quad li:last-child{border-bottom:none}
    .quad li::before{content:"";position:absolute;left:0;top:12px;width:8px;height:8px;border-radius:2px;background:linear-gradient(135deg,var(--navy),var(--gold))}
    .duo{grid-column:1/-1;display:grid;gap:16px;grid-template-columns:repeat(12,1fr)}
    .duo .left{grid-column:span 6;border-top:3px solid #dc2626}
    .duo .right{grid-column:span 6;border-top:3px solid #16a34a}
    .duo h3{margin-top:6px}
    .insights{grid-column:1/-1}
    .insights-grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
    .insights-grid .insite{grid-column:span 3}
    .insite{border:1px solid var(--line);border-radius:12px;background:#f9fbfd;padding:16px;box-shadow:var(--shadow-sm)}
    .insite strong{display:block;margin-bottom:6px;font-size:13px;letter-spacing:.3px;color:var(--ink)}
    .section-title{margin:10px 0 6px;font-size:14px;color:var(--muted);text-transform:uppercase;letter-spacing:1px}
    footer{margin-top:28px;padding-top:16px;border-top:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;font-size:12px;color:var(--muted)}
    @media (max-width:1024px){.center{grid-template-columns:1fr}.insights-grid .insite{grid-column:span 6}.duo .left,.duo .right{grid-column:span 12}}
    @media (max-width:640px){.insights-grid .insite{grid-column:span 12}}
    @page{size:A4;margin:14mm}
    @media print{
      body{background:#fff;padding:0}
      .card,.insite{box-shadow:none;backdrop-filter:none}
      a[href]::after{content:" (" attr(href) ")";font-size:10px;color:#64748b}
      h1.page-title{color:#000;background:none;-webkit-background-clip:initial}
    }
    .ico{display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;margin-right:8px;border-radius:6px;background:linear-gradient(135deg,var(--gold),var(--teal));box-shadow:0 2px 8px rgba(15,136,171,.25)}
    .ico svg{width:14px;height:14px;fill:none;stroke:#0b2f6b;stroke-width:1.6}
    .btn{appearance:none;border:0;border-radius:14px;padding:10px 16px;font-weight:700;cursor:pointer;position:relative;overflow:hidden;background:linear-gradient(90deg,var(--navy),var(--teal));color:#fff}
    .btn::before{content:"";position:absolute;inset:-2px;border-radius:16px;padding:2px;background:linear-gradient(90deg,var(--green),var(--teal),var(--gold));-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;animation:flow 8s ease-in-out infinite;background-size:200% 100%}
    .btn:hover{transform:translateY(-1px)}
    .bg-orbs{position:fixed;inset:0;pointer-events:none;z-index:-1;overflow:hidden}
    .bg-orbs span{position:absolute;filter:blur(40px);opacity:.28;border-radius:50%}
    .bg-orbs .o1{background:var(--gold);width:180px;height:180px;left:-40px;top:20vh;animation:float 14s ease-in-out infinite}
    .bg-orbs .o2{background:var(--teal);width:220px;height:220px;right:-60px;top:10vh;animation:float 18s ease-in-out infinite reverse}
    .bg-orbs .o3{background:var(--green);width:160px;height:160px;left:30%;bottom:-60px;animation:float 16s ease-in-out infinite}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-20px)}}
    .demo{display:grid;gap:12px}.demo .input{display:flex;gap:8px}
    .demo input[type="text"]{flex:1;border:1px solid var(--line);border-radius:12px;padding:12px 14px;font-size:14px;background:#fff}
    .demo-output{min-height:80px;border:1px dashed var(--line);border-radius:12px;padding:14px;background:#fff}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px}
    .kpi{border:1px solid var(--line);border-radius:12px;padding:12px;background:#f9fbff;text-align:center}
    .kpi strong{display:block;font-size:18px}
    .chatbot{display:grid;gap:12px}
    .chat-toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .chat-toolbar input[type="password"],.chat-toolbar input[type="text"]{border:1px solid var(--line);border-radius:10px;padding:10px 12px;font-size:13px;min-width:260px;background:#fff}
    .chat-toolbar .btn{white-space:nowrap}
    .store{display:grid;gap:10px;grid-template-columns:1fr}
    .store textarea{width:100%;min-height:120px;border:1px dashed var(--line);border-radius:12px;padding:12px;font-size:13px;background:#fff}
    .store small{color:var(--muted)}
    .chat-window{border:1px solid var(--line);border-radius:14px;background:#fff;min-height:220px;max-height:420px;overflow:auto;padding:12px}
    .msg{display:flex;gap:10px;margin:8px 0}
    .msg .bubble{border-radius:12px;padding:10px 12px;box-shadow:var(--shadow-sm)}
    .msg.user .bubble{background:#eef6ff}
    .msg.bot .bubble{background:#f8fbff}
    .assistant-avatar{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--navy),var(--gold));box-shadow:0 2px 6px rgba(0,0,0,.1)}
    .user-avatar{width:28px;height:28px;border-radius:999px;background:linear-gradient(135deg,var(--teal),var(--green))}
    .chat-input{display:flex;gap:8px}
    .chat-input textarea{flex:1;border:1px solid var(--line);border-radius:12px;padding:12px;min-height:58px;resize:vertical;font-size:14px;background:#fff}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:var(--accent-100);color:var(--navy);font-weight:700;font-size:12px}
    .progress{height:8px;background:#eef2ff;border-radius:999px;overflow:hidden}
    .progress>span{display:block;height:100%;background:linear-gradient(90deg,var(--green),var(--teal));width:0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="bg-orbs" aria-hidden="true"><span class="o1"></span><span class="o2"></span><span class="o3"></span></div>
    <header class="header" aria-label="Encabezado">
      <div class="brand">
        <img class="brand-logo" src="https://cotrafasocial.com/wp-content/uploads/2023/09/logo-cotrafasocial.png" alt="Cotrafa Social" />
        <div><div class="brand-title">Cotrafa Social</div><div class="brand-sub">Mapa de Empatía — Asistente Virtual</div></div>
      </div>
      <div class="meta"><span class="tag">Versión ejecutiva</span><span>Actualizado: <time datetime="2025-10-08">08 oct 2025</time></span></div>
    </header>

    <h1 class="page-title">Mapa de Empatía</h1>
    <p class="lead">Resumen claro y accionable de dolores, expectativas e insights para orientar decisiones de producto y adopción interna.</p>

    <section class="card center" aria-labelledby="usuario">
      <div class="who"><h3 id="usuario">Usuario objetivo</h3><p><strong>Empleados de Cotrafa Social</strong></p></div>
      <div class="need"><h3>Necesidad clave</h3><p>Consultar rápidamente información de proyectos (ejecutados y en proceso), responsables y documentación asociada en un repositorio confiable.</p></div>
    </section>

    <section class="grid" aria-label="Cuadrantes del mapa">
      <div class="card quad" style="grid-column: span 6;">
        <h4><span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24"><ellipse cx="12" cy="12" rx="8" ry="5"></ellipse><circle cx="12" cy="12" r="2.5"></circle></svg></span>¿Qué ve?</h4>
        <ul><li>Múltiples carpetas...</li><li>Nomenclaturas inconsistentes...</li><li>Compañeros solicitando información...</li><li>Sistemas desactualizados o incompletos</li><li>Documentos duplicados...</li><li>Ausencia de un repositorio central visible</li><li>Correos antiguos como única fuente histórica</li></ul>
      </div>
      <div class="card quad" style="grid-column: span 6;">
        <h4><span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M8 10 v4 a4 4 0 0 0 8 0 v-4"/><rect x="6" y="9" width="12" height="6" rx="3"/></svg></span>¿Qué escucha?</h4>
        <ul><li>“No sé dónde está ese documento”.</li><li>“Consúltalo con la persona que llevó el proyecto”.</li><li>“Busca en la carpeta compartida”.</li><li>“Esa información está desactualizada”.</li><li>Quejas de clientes por tiempos lentos.</li><li>Solicitudes urgentes de gerencia.</li><li>“Lo necesito para ayer”.</li></ul>
      </div>
      <div class="card quad" style="grid-column: span 6;">
        <h4><span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M12 21c4-3 7-5.5 7-9a7 7 0 0 0-13 0c0 3.5 3 6 6 9z"/></svg></span>¿Qué piensa y siente?</h4>
        <ul><li>“Pierdo tiempo...”</li><li>“¿Esta es la versión correcta?”</li><li>“Me incomoda preguntar otra vez”</li><li>“¿Y si decido con información incorrecta?”</li><li>“Debería haber una forma más sencilla”</li><li>“Me siento poco productivo...”</li><li>“Necesito más autonomía...”</li></ul>
      </div>
      <div class="card quad" style="grid-column: span 6;">
        <h4><span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="12" rx="4"/><path d="M8 17l-2.5 3"/></svg></span>¿Qué dice y hace?</h4>
        <ul><li>Envía varios correos solicitando información</li><li>Interrumpe a compañeros...</li><li>Explora múltiples carpetas...</li><li>Abre versiones hasta hallar la correcta</li><li>Guarda copias personales...</li><li>“¿Alguien sabe dónde está el proyecto de…?”</li><li>“¿Esta es la última versión?”</li></ul>
      </div>
    </section>

    <h2 class="section-title">Dolores y ganancias</h2>
    <section class="grid duo" aria-label="Dolores y ganancias">
      <div class="card quad left"><h3>Dolores</h3><ul><li>Pérdida de tiempo...</li><li>Frustración...</li><li>Inseguridad...</li><li>Dependencia...</li><li>Estrés...</li><li>Ineficiencia...</li><li>Duplicación...</li><li>Miedo a equivocarse</li><li>Interrupciones</li><li>Desmotivación</li></ul></div>
      <div class="card quad right"><h3>Ganancias</h3><ul><li>Acceso inmediato...</li><li>Búsqueda en lenguaje natural</li><li>Información vigente y confiable</li><li>Disponibilidad 24/7</li><li>Claridad de responsables</li><li>Trazabilidad</li><li>Mayor autonomía</li><li>Menos interrupciones</li><li>Respuestas más rápidas</li><li>Más tiempo estratégico</li></ul></div>
    </section>

    <!-- Chatbot funcional -->
    <h2 class="section-title">Chatbot Cotrafa (funcional con tu API Key)</h2>
    <section class="card chatbot" id="chatbot">
      <div class="chat-toolbar">
        <span class="pill">Config</span>
        <input type="password" id="apiKey" placeholder="Pega aquí tu OpenAI API Key (no se guarda)" aria-label="OpenAI API Key">
        <input type="text" id="orgId" placeholder="(Opcional) OpenAI Organization ID" aria-label="Organization ID">
        <button class="btn" id="saveKey" type="button">Usar clave</button>
        <button class="btn" id="clearKey" type="button">Olvidar</button>
      </div>
      <details class="store" id="store">
        <summary><strong>Base de conocimiento (RAG)</strong> — pega texto o carga JSON con tus proyectos</summary>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <input type="file" id="fileInput" accept=".json,.txt">
          <button class="btn" id="embedBtn" type="button">Crear/Actualizar embeddings</button>
          <div class="progress" style="flex:1;min-width:160px"><span id="progBar"></span></div>
          <small id="embedInfo">Sin datos aún</small>
        </div>
        <textarea id="rawDocs" placeholder='Ejemplo JSON: [{"id":"PRJ-001","titulo":"App Web","texto":"Descripción del proyecto..."}]
También puedes pegar texto libre; cada línea será un documento.'></textarea>
      </details>
      <div class="chat-window" id="chatWin" aria-live="polite"></div>
      <div class="chat-input">
        <textarea id="chatQ" placeholder="Haz una pregunta sobre tus proyectos..."></textarea>
        <button class="btn" id="sendQ" type="button">Enviar</button>
      </div>
      <small>Privacidad: la clave se guarda solo en memoria de esta página (no se envía a otro sitio). Para producción usa un proxy seguro en tu backend.</small>
    </section>

    <h2 class="section-title">Demo interactivo</h2>
    <section class="card demo" id="demo">
      <div class="input"><input type="text" id="demo-q" placeholder="Ej: ¿Cuál es el estado del proyecto de investigación de mercado?" aria-label="Pregunta de ejemplo" /><button class="btn" id="demo-btn" type="button">Probar</button></div>
      <div class="demo-output" id="demo-out" aria-live="polite"></div>
    </section>

    <h2 class="section-title">Insights para el diseño</h2>
    <section class="card insights">
      <div class="insights-grid">
        <div class="insite"><strong>1. Lenguaje natural</strong> Debe entender preguntas cotidianas, no solo códigos.</div>
        <div class="insite"><strong>2. Respuestas contextuales</strong> Resumen claro con opción a profundizar.</div>
        <div class="insite"><strong>3. Responsables visibles</strong> Contacto y rol actualizados.</div>
        <div class="insite"><strong>4. Estado de proyectos</strong> Ejecutado, en curso o suspendido.</div>
        <div class="insite"><strong>5. Búsqueda flexible</strong> Por nombre, ubicación, responsable, fecha o tipo.</div>
        <div class="insite"><strong>6. Confiabilidad</strong> Mostrar fecha de actualización y versión.</div>
        <div class="insite"><strong>7. Multiplataforma</strong> Acceso desde distintos dispositivos.</div>
        <div class="insite"><strong>8. Aprendizaje</strong> Mejora continua basada en uso.</div>
      </div>
    </section>

    <footer><span>Preparado por: Equipo de Innovación</span><span>© Cotrafa Social</span></footer>
  </div>

  <script>
  if (!window.__cotrafa_loaded__) {
    window.__cotrafa_loaded__ = true;

    // Demo con "tipeo"
    (function(){
      const btn=document.getElementById('demo-btn'),out=document.getElementById('demo-out'),q=document.getElementById('demo-q');
      if(!btn||!out||!q) return;
      const sample=(text)=>`<div class="insite" style="border:0;background:#fff"><div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><span class="ico" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M21 21l-5-5"/><circle cx="10" cy="10" r="6"/></svg></span><strong>Respuesta</strong></div><p><strong>Proyecto:</strong> Investigación de mercado (2025-Q3)<br/><strong>Estado:</strong> En curso ✅<br/><strong>Responsable:</strong> Ana Pérez — Unidad de Innovación<br/><strong>Última actualización:</strong> 02 oct 2025 — Informe preliminar cargado.</p><div class="kpis"><div class="kpi"><span>Tiempo ahorrado</span><strong>7 min</strong></div><div class="kpi"><span>Confianza</span><strong>98%</strong></div><div class="kpi"><span>Docs relevantes</span><strong>3</strong></div></div></div>`;
      function type(html){ out.innerHTML=''; const tmp=document.createElement('div'); tmp.innerHTML=html; const text=tmp.innerText; let i=0; out.textContent=''; const timer=setInterval(()=>{ out.textContent=text.slice(0,i+=3); if(i>=text.length){ clearInterval(timer); out.innerHTML=html; } },12); }
      btn.addEventListener('click',()=>{ const query=q.value.trim()||'¿Cuál es el estado del proyecto de investigación de mercado?'; type(sample(query)); });
    })();

    // Chatbot + RAG (modo ahorro)
    const $=(s)=>document.querySelector(s);
    const chatWin=$('#chatWin');
    const api={key:null,org:null};
    const vectorStore={docs:[],vectors:[],dim:1536};
    const cost={model:'gpt-4o-mini',embed:'text-embedding-3-small'}; // económicos

    function addMsg(role,html){ const wrap=document.createElement('div'); wrap.className=`msg ${role}`; const avatar=document.createElement('div'); avatar.className=role==='user'?'user-avatar':'assistant-avatar'; const bubble=document.createElement('div'); bubble.className='bubble'; bubble.innerHTML=html; wrap.append(avatar,bubble); chatWin.appendChild(wrap); chatWin.scrollTop=chatWin.scrollHeight; }

    $('#saveKey')?.addEventListener('click',()=>{ api.key=$('#apiKey').value.trim(); api.org=$('#orgId').value.trim()||null; addMsg('bot','<em>Clave configurada en memoria. Listo para usar.</em>'); });
    $('#clearKey')?.addEventListener('click',()=>{ api.key=null; api.org=null; $('#apiKey').value=''; $('#orgId').value=''; addMsg('bot','<em>Clave eliminada de memoria.</em>'); });

    async function embedTexts(texts){
      if(!api.key) throw new Error('Falta API Key');
      const chunks=[];
      texts.forEach((t,i)=>{ const id=typeof t==='string'?`doc-${i+1}`:(t.id||`doc-${i+1}`); const title=typeof t==='string'?`Documento ${i+1}`:(t.titulo||t.title||id); const body=typeof t==='string'?t:(t.texto||t.text||JSON.stringify(t)); const size=1800; for(let o=0;o<body.length;o+=size){ chunks.push({id:`${id}#${o}`,title,text:body.slice(o,o+size)}); } });
      const prog=$('#progBar'); if(prog) prog.style.width='0%';
      const batched=[]; const B=100; for(let i=0;i<chunks.length;i+=B){ batched.push(chunks.slice(i,i+B)); }
      const vectors=[];
      for(let bi=0;bi<batched.length;bi++){
        const batch=batched[bi];
        const res=await fetch('https://api.openai.com/v1/embeddings',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${api.key}`,...(api.org?{'OpenAI-Organization':api.org}:{})},body:JSON.stringify({model:cost.embed,input:batch.map(c=>c.text)})});
        if(!res.ok){ const e=await res.text(); throw new Error('Error embeddings: '+e); }
        const data=await res.json(); data.data.forEach((d,idx)=>{ vectors.push({v:new Float32Array(d.embedding),meta:batch[idx]}); });
        if(prog) prog.style.width=Math.round(((bi+1)/batched.length)*100)+'%';
      }
      vectorStore.docs=chunks; vectorStore.vectors=vectors; vectorStore.dim=vectors[0]?.v?.length||1536;
      const info=$('#embedInfo'); if(info) info.textContent=`Docs: ${chunks.length} | Vectores: ${vectors.length}`;
    }

    function cosine(a,b){ let s=0,na=0,nb=0; for(let i=0;i<a.length;i++){ s+=a[i]*b[i]; na+=a[i]*a[i]; nb+=b[i]*b[i]; } return s/(Math.sqrt(na)*Math.sqrt(nb)+1e-9); }

    async function retrieve(query){
      if(!vectorStore.vectors.length) return [];
      const er=await fetch('https://api.openai.com/v1/embeddings',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${api.key}`,...(api.org?{'OpenAI-Organization':api.org}:{})},body:JSON.stringify({model:cost.embed,input:query})});
      if(!er.ok){ const e=await er.text(); throw new Error('Error embedding query: '+e); }
      const ed=await er.json(); const qv=new Float32Array(ed.data[0].embedding);
      const scored=vectorStore.vectors.map(it=>({score:cosine(qv,it.v),meta:it.meta})).sort((a,b)=>b.score-a.score);
      return scored.slice(0,6).map(s=>s.meta);
    }

    async function chat(query){
      if(!api.key) throw new Error('Falta API Key');
      const context=await retrieve(query);
      const seen=new Set();
      const compact=(context||[]).filter(c=>{const k=c.title||c.id;if(seen.has(k))return false;seen.add(k);return true;}).slice(0,4).map(c=>({...c,text:(c.text||'').replace(/\s+/g,' ').slice(0,600)}));
      const ctxText=compact.map(c=>`[${c.id||''}] ${c.title}:\n${c.text}`).join('\n---\n');
      const sys='Eres el asistente de Cotrafa Social. Responde en español, ejecutivo y muy conciso (máx. 120 palabras). Usa sólo el Contexto. Si falta info, di: "No hay datos suficientes en la base de conocimiento".';
      const res=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${api.key}`,...(api.org?{'OpenAI-Organization':api.org}:{})},body:JSON.stringify({model:cost.model,messages:[{role:'system',content:sys},{role:'user',content:`Pregunta: ${query}\n\nContexto (fragmentos relevantes):\n${ctxText}\n\nResponde en 3 viñetas y 1 línea de próximos pasos.`}],temperature:0.1,max_tokens:250,top_p:1})});
      if(!res.ok){ throw new Error(await res.text()); }
      const data=await res.json();
      return { answer:data.choices?.[0]?.message?.content || '(sin respuesta)', context:compact };
    }

    // Botones
    document.getElementById('embedBtn')?.addEventListener('click', async ()=>{
      try{
        const file=document.getElementById('fileInput').files[0];
        let texts=[];
        if(file){ const txt=await file.text(); try{ texts=JSON.parse(txt);}catch{ texts=txt.split('\n').filter(Boolean);} }
        const extra=document.getElementById('rawDocs').value.trim();
        if(extra){ try{ texts=texts.concat(JSON.parse(extra)); }catch{ texts=texts.concat(extra.split('\n').filter(Boolean)); } }
        if(!texts.length){ addMsg('bot','<em>No hay datos para indexar.</em>'); return; }
        addMsg('bot','Creando embeddings…');
        await embedTexts(texts);
        addMsg('bot','<strong>Listo:</strong> base de conocimiento cargada.');
      }catch(e){ addMsg('bot',`<span style="color:#b91c1c">${e.message}</span>`); }
    });

    document.getElementById('sendQ')?.addEventListener('click', async ()=>{
      const q=document.getElementById('chatQ').value.trim(); if(!q) return;
      addMsg('user', q); document.getElementById('chatQ').value='';
      try{
        const {answer, context}=await chat(q);
        const ctxHtml=context.map(c=>`<details><summary>${c.title}</summary><pre style="white-space:pre-wrap">${c.text}</pre></details>`).join('');
        addMsg('bot', `${answer}\n\n<small style="opacity:.8">Modo ahorro: modelo ${cost.model}, contexto compacto (≤4 fragmentos, ≤600 caracteres c/u), máx. 250 tokens.</small>${ctxHtml?`<div style="margin-top:8px">${ctxHtml}</div>`:''}`);
      }catch(e){ addMsg('bot',`<span style="color:#b91c1c">${e.message}</span>`); }
    });
  }
  </script>
</body>
</html>
